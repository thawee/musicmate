<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: *;
        connect-src 'self' ws: wss:;
        font-src 'self' data:;
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="icons/bootstrap-icons.min.css">
    <script src="js/vibrant.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: {} }
        }
    </script>
    <style>
        /* ... [Your existing CSS styles remain unchanged] ... */

        /* Light Theme Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e9ecef; }
        ::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6c757d; }

        /* Dark Theme Scrollbar Override */
        .dark ::-webkit-scrollbar-track { background: #212529; }
        .dark ::-webkit-scrollbar-thumb { background: #495057; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6c757d; }

        /* Progress Bar */
        progress[value] { -webkit-appearance: none; appearance: none; height: 6px; }
        progress[value]::-webkit-progress-bar { background-color: #dee2e6; border-radius: 3px; }
        progress[value]::-webkit-progress-value { background-color: #495057; border-radius: 3px; transition: width 0.1s linear; }
        .dark progress[value]::-webkit-progress-bar { background-color: #495057; }
        .dark progress[value]::-webkit-progress-value { background-color: #dee2e6; }

        .overlay-screen { transition: opacity 0.3s ease-in-out; }
        .info-content a { color: #60a5fa; text-decoration: underline; }

        /* Animated Equalizer Icon */
        .playing-icon { display: flex; justify-content: space-between; width: 14px; height: 14px; align-items: flex-end; }
        .playing-icon .bar { width: 3px; height: 100%; background-color: #60a5fa; animation: bounce 1.2s ease-in-out infinite; }
        .playing-icon .bar:nth-child(2) { animation-delay: -1.0s; }
        .playing-icon .bar:nth-child(3) { animation-delay: -0.8s; }
        @keyframes bounce { 0%, 40%, 100% { transform: scaleY(0.2); } 20% { transform: scaleY(1.0); } }

        /* Style for the currently playing song in the queue */
        .playing-item { background-color: rgba(59, 130, 246, 0.20); }
        .dark .playing-item { background-color: rgba(59, 130, 246, 0.10); }

        .badge-separator {
            display: none; /* Hidden by default */
            margin: 0 6px;
            color: #9ca3af; /* Muted text color */
            font-weight: bold;
        }
        .dark .badge-separator {
            color: #6b7280;
        }

        #player-footer.has-color-bg {
            color: #e5e7eb;
            border-top-color: transparent;
        }
        #player-footer.has-color-bg h3 { color: #ffffff; }
        #player-footer.has-color-bg p,
        #player-footer.has-color-bg .text-gray-600,
        #player-footer.has-color-bg .text-gray-500,
        #player-footer.has-color-bg .font-mono { color: #d1d5db; }
        #player-footer.has-color-bg i,
        #player-footer.has-color-bg .text-gray-600,
        #player-footer.has-color-bg .text-2xl { color: #e5e7eb; }
        #player-footer.has-color-bg .hover\:text-black:hover,
        #player-footer.has-color-bg .dark\:hover\:text-white:hover { color: #ffffff !important; }
        #player-footer.has-color-bg .text-blue-500 { color: #60a5fa !important; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-300 flex flex-col h-screen overflow-hidden font-sans">

<div id="main-ui" class="flex flex-col h-full">
    <header class="bg-white dark:bg-black dark:bg-opacity-20 px-4 py-3 flex-shrink-0 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <a class="text-xl font-semibold text-black dark:text-white" href="#"><i class="bi bi-headphones mr-2"></i>MusicMate</a>
        <div id="stats-summary" class="hidden sm:flex items-center space-x-6 text-center">
            <div class="flex flex-col">
                <span id="stats-songs" class="text-lg font-semibold text-black dark:text-white">0</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">LIBRARY</span>
            </div>
            <div class="flex flex-col">
                <span id="stats-total-duration" class="text-lg font-semibold text-black dark:text-white">0</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">DURATION</span>
            </div>
            <div class="flex flex-col">
                <span id="stats-total-size" class="text-lg font-semibold text-black dark:text-white">0</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">STORAGE</span>
            </div>
        </div>
        <div class="flex items-center space-x-4 text-xl">
            <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">
                <i class="bi bi-sun-fill hidden"></i> <i class="bi bi-moon-stars-fill"></i>
            </button>
        </div>
    </header>

    <div class="bg-gray-200 dark:bg-gray-800 px-4 py-3 flex items-center justify-between flex-shrink-0 border-b border-gray-300 dark:border-gray-700">
        <div class="flex items-center space-x-4 flex-grow min-w-0">
            <div id="view-switcher" class="text-xl text-gray-500 dark:text-gray-400 space-x-2 flex-shrink-0">
                <button id="library-btn" title="Library" class="...[your classes]...">
                    <i class="bi bi-collection"></i>
                </button>
                <button id="queue-btn" title="Playing Queue" class="...[your classes]...">
                    <i class="bi bi-music-note-list"></i>
                </button>
                <span class="border-l border-gray-400 dark:border-gray-600 h-6"></span>
                <i id="grid-view-btn" class="bi bi-grid-fill cursor-pointer text-black dark:text-white" title="Grid View"></i>
                <i id="list-view-btn" class="bi bi-list-ul cursor-pointer hover:text-black dark:hover:text-white" title="List View"></i>
            </div>
            <div id="breadcrumb" class="text-sm text-gray-500 dark:text-gray-400 truncate"></div>
        </div>
        <div class="flex items-center space-x-2 flex-shrink-0">
            <div class="flex items-center">
                <button class="bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-300 py-1 px-3 rounded-l-md inline-flex items-center text-sm"><span>Title</span></button>
                <input type="text" class="bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm focus:ring-blue-500 focus:border-blue-500 block w-48 p-1" placeholder="Search...">
            </div>
            <i id="empty-queue-btn" class="bi bi-trash text-xl text-gray-500 dark:text-gray-400 cursor-pointer hover:text-black dark:hover:text-white" title="Empty Queue"></i>
        </div>
    </div>

    <main id="main-content-area" class="flex-grow overflow-y-auto p-4">
        <div id="library-content" class="">
            <div id="library-grid-view"><div id="album-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-4"></div></div>
            <div id="library-list-view" class="hidden"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-200 dark:bg-gray-800"><tr><th scope="col" class="px-6 py-3">Name</th><th scope="col" class="px-6 py-3">Artist</th><th scope="col" class="px-6 py-3">Album</th><th scope="col" class="px-6 py-3 text-right"><i class="bi bi-clock"></i></th></tr></thead><tbody id="song-list"></tbody></table></div>
        </div>
        <div id="queue-content" class="hidden">
            <div id="queue-grid-view" class="hidden"><div id="queue-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-4"></div></div>
            <div id="queue-list-view" class=""><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-200 dark:bg-gray-800"><tr><th scope="col" class="px-6 py-3">#</th><th scope="col" class="px-6 py-3">Title</th><th scope="col" class="px-6 py-3">Artist</th><th scope="col" class="px-6 py-3">Album</th></tr></thead><tbody id="queue-list-body"></tbody></table></div>
        </div>
    </main>
</div>

<footer id="player-footer" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-300 dark:border-gray-800 shadow-2xl z-10 transition-colors duration-500">
    <div class="w-full max-w-screen-2xl mx-auto md:p-3"> <div class="hidden md:flex items-center space-x-6">

        <div class="flex-1 min-w-0 flex items-center space-x-4 truncate">
            <img id="footer-album-art" src="assets/no_cover.png" class="w-16 h-16 rounded object-cover cursor-pointer hover:ring-2 ring-blue-500 transition" alt="">
            <div class="truncate">
                <div class="flex items-center space-x-2">
                    <h3 id="footer-title" class="font-bold text-black dark:text-white truncate">No Song Playing</h3>
                    <div id="footer-quality-badge"></div>
                </div>
                <p id="footer-artist-album" class="text-sm text-gray-600 dark:text-gray-400 truncate">Artist - Album</p>
            </div>
        </div>

        <div class="flex flex-col items-center flex-shrink-0">
            <div class="flex items-center space-x-6 text-2xl text-gray-600 dark:text-gray-300">
                <i id="shuffle-btn" class="bi bi-shuffle cursor-pointer hover:text-blue-500" title="Shuffle"></i>
                <i id="prev-btn" class="bi bi-skip-start-fill text-3xl cursor-pointer hover:text-black dark:hover:text-white"></i>
                <i id="play-pause-btn" class="bi bi-play-circle-fill text-5xl cursor-pointer hover:text-black dark:hover:text-white"></i>
                <i id="next-btn" class="bi bi-skip-end-fill text-3xl cursor-pointer hover:text-black dark:hover:text-white"></i>
                <i id="repeat-btn" class="bi bi-repeat cursor-pointer hover:text-blue-500" title="Repeat All"></i>
            </div>
            <div class="w-full flex items-center space-x-2 text-xs font-mono text-gray-500 dark:text-gray-400 mt-1">
                <span id="player-time-current">0:00</span>
                <progress id="player-progress" class="w-full h-1.5 cursor-pointer" value="0" max="100"></progress>
                <span id="player-time-duration">0:00</span>
            </div>
        </div>

        <div class="flex-1 min-w-0 flex items-center justify-end space-x-4">
            <span id="footer-renderer-name" class="text-sm text-gray-500 dark:text-gray-400 truncate">Local Playback</span>
            <div id="footer-renderer-container" class="relative">
                <button id="footer-renderer-btn" class="text-2xl text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white"><i class="bi bi-speaker"></i></button>
                <div id="footer-renderer-list" class="absolute hidden bottom-full right-0 mb-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20 border border-gray-200 dark:border-gray-700"></div>
            </div>
        </div>
    </div>

        <div class="md:hidden flex flex-col px-4 pt-1.5 pb-2">
            <div class="w-full flex items-center space-x-2 text-xs font-mono text-gray-500 dark:text-gray-400">
                <span id="player-time-current-mobile">0:00</span>
                <progress id="player-progress-mobile" class="w-full h-1.5" value="0" max="100"></progress>
                <span id="player-time-duration-mobile">0:00</span>
            </div>
            <div class="flex items-center justify-between mt-2">
                <div class="flex items-center space-x-3 truncate min-w-0">
                    <img id="footer-album-art-mobile" src="assets/no_cover.png" class="w-9 h-9 rounded object-cover cursor-pointer" alt="">
                    <div class="truncate">
                        <div class="flex items-center space-x-1.5">
                            <h3 id="footer-title-mobile" class="font-bold text-black dark:text-white truncate">No Song Playing</h3>
                            <div id="footer-quality-badge-mobile"></div>
                        </div>
                        <p id="footer-artist-album-mobile" class="text-sm text-gray-600 dark:text-gray-400 truncate">Artist - Album</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4 text-3xl flex-shrink-0 pl-4">
                    <i id="play-pause-btn-mobile" class="bi bi-play-circle-fill cursor-pointer text-4xl"></i>
                    <i id="next-btn-mobile" class="bi bi-skip-end-fill cursor-pointer"></i>
                </div>
            </div>
        </div>

    </div>
</footer>

<div id="toast" class="fixed bottom-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-md shadow-lg opacity-0 transition-opacity"></div>

<div id="song-info-screen" class="overlay-screen fixed inset-0 bg-gray-100/95 dark:bg-gray-900/95 backdrop-blur-lg h-full w-full flex items-center justify-center p-4 lg:p-8 z-40 hidden opacity-0">

    <button id="close-song-info-btn" class="absolute top-5 right-8 text-4xl text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white z-10">&times;</button>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 max-w-6xl w-full h-full lg:h-auto">
        <div class="lg:col-span-2 flex flex-col items-center justify-center text-center">
            <img id="info-art" src="assets/no_cover.png" class="w-64 h-64 lg:w-80 lg:h-80 object-cover rounded-lg shadow-2xl">
            <h1 id="info-title" class="text-3xl lg:text-4xl font-bold text-black dark:text-white mt-4">Song Title</h1>
            <h2 id="info-artist" class="text-xl lg:text-2xl text-blue-600 dark:text-blue-400 mt-1">Artist Name</h2>
            <p id="info-album" class="text-md lg:text-lg text-gray-600 dark:text-gray-400 mt-1">from the album "Album Name"</p>
        </div>

        <div class="lg:col-span-3 bg-white/50 dark:bg-black dark:bg-opacity-20 rounded-lg p-6 flex flex-col h-[60vh] lg:h-auto">
            <div class="flex-shrink-0 border-b border-gray-300 dark:border-gray-700">
                <h3 class="px-3 py-2 font-medium text-black dark:text-white text-lg">Music & Artist Information</h3>
            </div>
            <div class="flex-grow overflow-y-auto mt-4 pr-2 info-content">
                <div id="info-content-area"></div>
                <div id="info-loading-spinner" class="hidden text-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-600 dark:border-gray-300 mx-auto"></div>
                    <p class="mt-4">Fetching info...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="now-playing-screen" class="overlay-screen fixed inset-0 h-full w-full flex items-center justify-center z-50 hidden opacity-0 p-8">
    <div id="now-playing-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-500"></div>
    <div class="absolute inset-0 bg-black/50 backdrop-blur-xl"></div>

    <button id="close-now-playing-btn" class="absolute top-5 right-8 text-4xl text-gray-300 hover:text-white z-20">&times;</button>

    <div class="relative w-full max-w-6xl px-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-start">

            <div class="flex-shrink-0 flex justify-center">
                <img id="now-playing-art" src="assets/no_cover.png" class="w-64 h-64 md:w-96 md:h-96 rounded-lg shadow-2xl">
            </div>

            <div class="flex flex-col text-white w-full h-full">
                <div>
                    <div id="now-playing-quality-details" class="font-mono text-sm text-blue-300 mb-2">
                        <span id="badge-format" class="badge"></span>
                        <span id="sep-format-rate" class="badge-separator">&bull;</span>
                        <span id="badge-samplerate" class="badge"></span>
                        <span id="sep-rate-depth" class="badge-separator">&bull;</span>
                        <span id="badge-bitdepth" class="badge"></span>
                        <span id="sep-depth-dr" class="badge-separator">&bull;</span>
                        <span id="badge-drs" class="badge"></span>
                        <span id="sep-depth-tier" class="badge-separator">&bull;</span>
                        <span id="badge-quality-tier" class="badge tier-badge"></span>
                    </div>

                    <div class="flex items-baseline space-x-4">
                        <h1 id="now-playing-title" class="text-3xl md:text-5xl font-bold truncate">Song Title</h1>
                    </div>
                    <h2 id="now-playing-artist" class="text-xl md:text-2xl text-gray-300 mt-1">Artist Name</h2>

                    <div class="flex items-center space-x-3 text-lg text-gray-400 mt-1">
                        <p id="now-playing-album" class="truncate hidden">Album Name</p>
                        <span id="now-playing-year-separator" class="hidden">&bull;</span>
                        <p id="now-playing-year" class="flex-shrink-0 hidden">Year</p>
                    </div>

                    <p id="now-playing-renderer" class="text-md text-gray-400 mt-2 flex items-center"></p>

                    <div class="mt-6 w-full">
                        <canvas id="waveform-canvas" class="w-full h-16"></canvas>
                    </div>

                    <div class="flex justify-between text-sm font-mono text-gray-400 mt-1">
                        <span id="now-playing-time-current">0:00</span>
                        <span id="now-playing-time-duration">0:00</span>
                    </div>
                </div>

                <div id="now-playing-metadata" class="mt-8 pt-6 border-t border-white/20 text-gray-300 text-sm overflow-y-auto max-h-[30vh]">
                    <div id="metadata-loading-spinner" class="hidden text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300 mx-auto"></div>
                    </div>
                    <div id="now-playing-metadata-content">
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
<div id="confirmation-modal" class="overlay-screen fixed inset-0 bg-gray-900/60 backdrop-blur-sm h-full w-full flex items-center justify-center z-50 hidden opacity-0">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md m-4">
        <div class="p-6">
            <h3 id="modal-title" class="text-xl font-semibold text-gray-900 dark:text-white">Are you sure?</h3>
            <p id="modal-text" class="mt-2 text-gray-600 dark:text-gray-400">This action cannot be undone.</p>
        </div>
        <div class="bg-gray-100 dark:bg-gray-700 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
            <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500">Cancel</button>
            <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- THEME SWITCHER LOGIC ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = themeToggleBtn.querySelector('.bi-sun-fill');
        const moonIcon = themeToggleBtn.querySelector('.bi-moon-stars-fill');

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        };

        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme) { applyTheme(savedTheme); }
        else if (prefersDark) { applyTheme('dark'); }
        else { applyTheme('light'); }

        // --- CONFIG & STATE ---
        let currentMainView = 'library';
        let currentDisplayMode = 'grid';
        let currentBrowsePath = 'Library';
        let shuffleMode = false;
        let repeatMode = 'none';
        let currentTrack = null; // Will hold the static { "track": {...} } object from 'nowPlaying'
        let currentPlaybackState = { state: 'stopped', elapsed: 0, duration: 0, trackId: null };
        let currentRenderer = null;
        let trackMetadataCache = new Map(); // Caches heavy data like waveforms

        // --- UI ELEMENTS ---
        const ui = {
            mainContentArea: document.getElementById('main-content-area'),
            libraryBtn: document.getElementById('library-btn'),
            queueBtn: document.getElementById('queue-btn'),
            gridViewBtn: document.getElementById('grid-view-btn'),
            listViewBtn: document.getElementById('list-view-btn'),
            libraryContent: document.getElementById('library-content'),
            queueContent: document.getElementById('queue-content'),
            libraryGridView: document.getElementById('library-grid-view'),
            libraryListView: document.getElementById('library-list-view'),
            queueGridView: document.getElementById('queue-grid-view'),
            queueListView: document.getElementById('queue-list-view'),
            emptyQueueBtn: document.getElementById('empty-queue-btn'),
            albumGrid: document.getElementById('album-grid'),
            songList: document.getElementById('song-list'),
            queueGrid: document.getElementById('queue-grid'),
            queueListBody: document.getElementById('queue-list-body'),
            breadcrumb: document.getElementById('breadcrumb'),
            songInfoScreen: document.getElementById('song-info-screen'),
            closeSongInfoBtn: document.getElementById('close-song-info-btn'),
            infoArt: document.getElementById('info-art'),
            infoTitle: document.getElementById('info-title'),
            infoArtist: document.getElementById('info-artist'),
            infoAlbum: document.getElementById('info-album'),
            infoContentArea: document.getElementById('info-content-area'),
            infoLoadingSpinner: document.getElementById('info-loading-spinner'),
            nowPlayingScreen: document.getElementById('now-playing-screen'),
            closeNowPlayingBtn: document.getElementById('close-now-playing-btn'),
            nowPlayingBg: document.getElementById('now-playing-bg'),
            nowPlayingArt: document.getElementById('now-playing-art'),
            nowPlayingTitle: document.getElementById('now-playing-title'),
            nowPlayingArtist: document.getElementById('now-playing-artist'),
            nowPlayingAlbum: document.getElementById('now-playing-album'),
            nowPlayingYear: document.getElementById('now-playing-year'),
            nowPlayingYearSeparator: document.getElementById('now-playing-year-separator'),
            nowPlayingRenderer: document.getElementById('now-playing-renderer'),
            waveformCanvas: document.getElementById('waveform-canvas'),
            nowPlayingTimeCurrent: document.getElementById('now-playing-time-current'),
            nowPlayingTimeDuration: document.getElementById('now-playing-time-duration'),
            badgeFormat: document.getElementById('badge-format'),
            badgeSampleRate: document.getElementById('badge-samplerate'),
            badgeBitDepth: document.getElementById('badge-bitdepth'),
            badgeDrs: document.getElementById('badge-drs'),
            badgeQualityTier: document.getElementById('badge-quality-tier'),
            sepFormatRate: document.getElementById('sep-format-rate'),
            sepRateDepth: document.getElementById('sep-rate-depth'),
            sepDepthDr: document.getElementById('sep-depth-dr'),
            sepDepthTier: document.getElementById('sep-depth-tier'),
            nowPlayingMetadata: document.getElementById('now-playing-metadata'),
            nowPlayingMetadataContent: document.getElementById('now-playing-metadata-content'),
            metadataLoadingSpinner: document.getElementById('metadata-loading-spinner'),
            rendererDropdownBtn: document.getElementById('footer-renderer-btn'),
            rendererDropdownList: document.getElementById('footer-renderer-list'),
            footerRendererName: document.getElementById('footer-renderer-name'),
            statsSongs: document.getElementById('stats-songs'),
            statsSize: document.getElementById('stats-total-size'),
            statsDuration: document.getElementById('stats-total-duration'),

            // Player Controls (grouped)
            desktopPlayer: {
                playPauseBtn: document.getElementById('play-pause-btn'),
                nextBtn: document.getElementById('next-btn'),
                prevBtn: document.getElementById('prev-btn'),
                shuffleBtn: document.getElementById('shuffle-btn'),
                repeatBtn: document.getElementById('repeat-btn'),
                albumArt: document.getElementById('footer-album-art'),
                title: document.getElementById('footer-title'),
                artistAlbum: document.getElementById('footer-artist-album'),
                qualityBadge: document.getElementById('footer-quality-badge'),
                progress: document.getElementById('player-progress'),
                currentTime: document.getElementById('player-time-current'),
                duration: document.getElementById('player-time-duration'),
            },
            mobilePlayer: {
                playPauseBtn: document.getElementById('play-pause-btn-mobile'),
                nextBtn: document.getElementById('next-btn-mobile'),
                albumArt: document.getElementById('footer-album-art-mobile'),
                progress: document.getElementById('player-progress-mobile'),
                currentTime: document.getElementById('player-time-current-mobile'),
                duration: document.getElementById('player-time-duration-mobile'),
                title: document.getElementById('footer-title-mobile'),
                artistAlbum: document.getElementById('footer-artist-album-mobile'),
                qualityBadge: document.getElementById('footer-quality-badge-mobile'),
            },

            // Confirmation Modal
            confirmationModal: document.getElementById('confirmation-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalText: document.getElementById('modal-text'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
        };

        // --- EVENT LISTENERS ---
        // ... [Your existing event listeners remain unchanged] ...
        ui.libraryBtn.addEventListener('click', () => setMainView('library'));
        ui.queueBtn.addEventListener('click', () => setMainView('queue'));
        ui.gridViewBtn.addEventListener('click', () => setDisplayMode('grid'));
        ui.listViewBtn.addEventListener('click', () => setDisplayMode('list'));
        ui.closeSongInfoBtn.addEventListener('click', () => closeOverlay(ui.songInfoScreen));
        ui.mainContentArea.addEventListener('click', handleItemClick);
        ui.breadcrumb.addEventListener('click', handleItemClick);
        ui.rendererDropdownBtn.addEventListener('click', (e) => { e.stopPropagation(); ui.rendererDropdownList.classList.toggle('hidden'); });
        document.addEventListener('click', () => ui.rendererDropdownList.classList.add('hidden'));
        ui.rendererDropdownList.addEventListener('click', handleRendererSelect);
        ui.closeNowPlayingBtn.addEventListener('click', () => closeOverlay(ui.nowPlayingScreen));
        ui.desktopPlayer.albumArt.addEventListener('click', () => openNowPlayingScreen());
        ui.desktopPlayer.playPauseBtn.addEventListener('click', () => sendMessage({ command: 'togglePlayPause' }));
        ui.desktopPlayer.nextBtn.addEventListener('click', () => sendMessage({ command: 'next' }));
        ui.desktopPlayer.prevBtn.addEventListener('click', () => sendMessage({ command: 'previous' }));
        ui.emptyQueueBtn.addEventListener('click', handleEmptyQueue);
        ui.desktopPlayer.shuffleBtn.addEventListener('click', handleShuffleToggle);
        ui.desktopPlayer.repeatBtn.addEventListener('click', handleRepeatToggle);
        ui.mobilePlayer.playPauseBtn.addEventListener('click', () => sendMessage({ command: 'togglePlayPause' }));
        ui.mobilePlayer.nextBtn.addEventListener('click', () => sendMessage({ command: 'next' }));
        ui.mobilePlayer.albumArt.addEventListener('click', () => openNowPlayingScreen());
        ui.modalCancelBtn.addEventListener('click', () => closeOverlay(ui.confirmationModal));
        window.addEventListener('resize', resizeWaveformCanvas);


        // --- EVENT HANDLERS & UI LOGIC ---
        // ... [handleItemClick, setMainView, openSongInfoOverlay, setDisplayMode, renderView, handleRendererSelect, openOverlay, closeOverlay remain unchanged] ...
        function handleItemClick(e) {
            const folderLink = e.target.closest('a[data-path]');
            if (folderLink) {
                e.preventDefault();
                sendMessage({ command: 'browse', path: folderLink.dataset.path });
                return;
            }
            const infoBtn = e.target.closest('.song-info-btn');
            if (infoBtn) {
                e.stopPropagation();
                openSongInfoOverlay({ id: infoBtn.dataset.id });
                return;
            }
            const delBtn = e.target.closest('.delete-queue-item-btn');
            if (delBtn) {
                e.stopPropagation();
                sendMessage({ command: 'removeFromQueue', id: delBtn.dataset.id });
                return;
            }
            const queueBtn = e.target.closest('.add-to-queue-btn');
            if (queueBtn) {
                e.stopPropagation();
                sendMessage({ command: 'addToQueue', id: queueBtn.dataset.id });
                showToast('Added to queue!');
                return;
            }
            const itemElement = e.target.closest('[data-id]');
            if (!itemElement) return;
            const type = itemElement.dataset.type;
            if (type === 'folder') { sendMessage({ command: 'browse', path: itemElement.dataset.path }); }
            else if (type === 'song') {
                if (currentMainView === 'library') {
                    sendMessage({ command: 'playFromContext', id: itemElement.dataset.id, path: currentBrowsePath });
                } else {
                    sendMessage({ command: 'play', id: itemElement.dataset.id });
                }
            }
        }

        function setMainView(view) {
            if (view === 'library') {
                if (currentMainView === 'library') {
                    sendMessage({ command: 'browse', path: 'Library' });
                } else {
                    currentMainView = 'library';
                    renderView();
                }
            } else if (view === 'queue') {
                if (currentMainView === 'queue') return;
                currentMainView = 'queue';
                sendMessage({ command: 'getQueue' });
                renderView();
            }
        }

        function openSongInfoOverlay(trackData) {
            if (trackData.id && !trackData.title) {
                 sendMessage({ command: 'getTrackDetails', id: trackData.id });
                 return;
            }
            ui.infoArt.src = trackData.artUrl || 'assets/no_cover.png';
            ui.infoTitle.textContent = trackData.title;
            ui.infoArtist.textContent = trackData.artist || 'Unknown Artist';
            ui.infoAlbum.textContent = trackData.album ? `from the album "${trackData.album}"` : '';

            const metadata = trackMetadataCache.get(trackData.id);
            if (metadata) {
                renderTrackInfo(metadata.info);
                ui.infoLoadingSpinner.classList.add('hidden');
            } else {
                ui.infoLoadingSpinner.classList.remove('hidden');
                ui.infoContentArea.innerHTML = '';
                sendMessage({ command: 'getTrackMetadata', id: trackData.id, artist: trackData.artist, album: trackData.album });
            }

            openOverlay(ui.songInfoScreen);
        }

        function setDisplayMode(mode) {
            currentDisplayMode = mode;
            renderView();
        }

        function renderView() {
            ui.libraryContent.classList.add('hidden');
            ui.queueContent.classList.add('hidden');
            const activeClasses = ['text-black', 'dark:text-white'];
            const inactiveClasses = ['hover:text-black', 'dark:hover:text-white'];
            ui.libraryBtn.classList.remove(...activeClasses, ...inactiveClasses);
            ui.queueBtn.classList.remove(...activeClasses, ...inactiveClasses);
            ui.libraryBtn.classList.add(...(currentMainView === 'library' ? activeClasses : inactiveClasses));
            ui.queueBtn.classList.add(...(currentMainView === 'queue' ? activeClasses : inactiveClasses));

            ui.gridViewBtn.classList.toggle('text-black', currentDisplayMode === 'grid');
            ui.gridViewBtn.classList.toggle('dark:text-white', currentDisplayMode === 'grid');
            ui.listViewBtn.classList.toggle('text-black', currentDisplayMode === 'list');
            ui.listViewBtn.classList.toggle('dark:text-white', currentDisplayMode === 'list');

            if (currentMainView === 'library') {
                ui.libraryContent.classList.remove('hidden');
                ui.libraryGridView.classList.toggle('hidden', currentDisplayMode !== 'grid');
                ui.libraryListView.classList.toggle('hidden', currentDisplayMode !== 'list');
            } else { // queue
                ui.queueContent.classList.remove('hidden');
                ui.queueGridView.classList.toggle('hidden', currentDisplayMode !== 'grid');
                ui.queueListView.classList.toggle('hidden', currentDisplayMode !== 'list');
            }
            ui.emptyQueueBtn.style.display = (currentMainView === 'queue') ? 'inline-block' : 'none';
        }

        function handleRendererSelect(e) {
            e.preventDefault();
            const rendererLink = e.target.closest('a[data-udn]');
            if (rendererLink) {
                const udn = rendererLink.dataset.udn;
                sendMessage({ command: 'setRenderer', udn: udn });
                showToast(`Switched player to ${rendererLink.dataset.name}`);
                ui.rendererDropdownList.classList.add('hidden');
            }
        }

        function openOverlay(overlay) { overlay.classList.remove('hidden'); setTimeout(() => overlay.classList.remove('opacity-0'), 10); }
        function closeOverlay(overlay) { overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 300); }


        // --- WEBSOCKET LOGIC ---
        const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${scheme}://${window.location.hostname}:9000/ws`;
        let socket;

        function connect() {
            try { socket = new WebSocket(wsUrl); }
            catch (e) { console.error("WS connect error:", e); setTimeout(connect, 3000); return; }

            socket.onopen = () => {
                console.log("WebSocket connected. Requesting library content...");
                sendMessage({ command: 'browse', path: currentBrowsePath });
            };
            socket.onmessage = (event) => handleServerMessage(JSON.parse(event.data));
            socket.onclose = () => { console.warn("WebSocket closed. Reconnecting..."); setTimeout(connect, 3000); };
            socket.onerror = (error) => { console.error("WS error:", error); socket.close(); };
        }
        function sendMessage(message) { if (socket && socket.readyState === WebSocket.OPEN) socket.send(JSON.stringify(message)); }

        function handleServerMessage(data) {
            switch (data.type) {
                case 'browseResult':
                    currentBrowsePath = data.path;
                    updateLibraryItems(data.items);
                    updateBreadcrumb(data.path, data.items);
                    break;
                case 'nowPlaying':
                    currentTrack = data.track;
                    if (currentTrack && !ui.nowPlayingScreen.classList.contains('hidden') && !trackMetadataCache.has(currentTrack.id)) {
                        sendMessage({ command: 'getTrackMetadata', id: currentTrack.id, artist: currentTrack.artist, album: currentTrack.album });
                    }
                    updatePlayerUI();
                    break;
                case 'playbackState':
                    if ((!currentTrack && data.trackId) || (currentTrack && currentTrack.id != data.trackId)) {
                        if (data.trackId) {
                            sendMessage({ command: 'getNowPlaying' });
                        } else {
                            currentTrack = null; // Nothing is playing
                        }
                    }
                    currentPlaybackState = data;
                    updatePlayerUI();
                    break;
                case 'trackMetadata':
                    trackMetadataCache.set(data.trackId, data);
                    if (!ui.songInfoScreen.classList.contains('hidden') && ui.infoTitle.textContent === currentTrack?.title) {
                         ui.infoLoadingSpinner.classList.add('hidden');
                         renderTrackInfo(data.info);
                    }

                    if (currentTrack && currentTrack.id === data.trackId && !ui.nowPlayingScreen.classList.contains('hidden')) {
                        // --- BUG FIX: Correctly calculate progress ---
                        // Get the current state and duration
                        const state = currentPlaybackState;
                        const duration = (currentTrack ? currentTrack.duration : 0) || state.duration || 0;
                        // Calculate progress 0-100
                        const progress = (duration > 0) ? (state.elapsed / duration) * 100 : 0;
                        // Calculate progress ratio 0-1
                        const progressRatio = progress / 100;

                        updateNowPlayingScreenVisuals(progressRatio); // Pass the 0-1 ratio
                    }
                    break;
                case 'availableRenderers':
                    updateRendererList(data.renderers);
                    updateRendererCheckmarks();
                    break;
                case 'playerStatus':
                    currentRenderer = data
                    ui.footerRendererName.textContent = data.name;
                    updateRendererCheckmarks();

                    if (!ui.nowPlayingScreen.classList.contains('hidden')) {
                        ui.nowPlayingRenderer.innerHTML = `<i class="bi bi-speaker-fill mr-2"></i>${data.name}`;
                    }
                    break;
                case 'updateQueue':
                    updateQueueItems(data.queue);
                    updateBreadcrumb("Playing Queue", data.queue);
                    break;
                case 'trackInfoResult':
                    ui.infoLoadingSpinner.classList.add('hidden');
                    if (data.info && data.info.highResArtUrl) ui.nowPlayingArt.src = data.info.highResArtUrl;
                    renderTrackInfo(data.info);
                    break;
                case 'trackDetailsResult':
                    openSongInfoOverlay(data.track);
                    break;
                case 'statsUpdate':
                    updateStats(data.stats);
                    break;
            }
        }

        // --- RENDERING LOGIC ---
        // ... [formatTime, updateBreadcrumb, updateAlbumGrid, updateSongList, updateQueueList remain unchanged] ...
        function updateLibraryItems(items) {
            updateAlbumGrid(items);
            updateSongList(items);
            const isFolderOnly = items.every(item => item.type === 'folder');
            ui.listViewBtn.classList.toggle('opacity-50', isFolderOnly);
            ui.listViewBtn.classList.toggle('pointer-events-none', isFolderOnly);
            if (isFolderOnly && currentDisplayMode === 'list') { setDisplayMode('grid'); }
        }

        function updateQueueItems(queue) {
            updateQueueGrid(queue);
            updateQueueList(queue);
        }

        function formatTime(seconds) { if (isNaN(seconds)) return '0:00'; const min = Math.floor(seconds / 60); const sec = Math.floor(seconds % 60).toString().padStart(2, '0'); return `${min}:${sec}`; }

        function updateBreadcrumb(path = '', items = []) {
            const breadcrumbList = document.createElement('ol');
            breadcrumbList.className = 'flex items-center space-x-2';
            const parts = path.split('/').filter(part => part);
            if (parts.length === 0) { parts.push('Library'); }

            parts.forEach((part, index) => {
                const currentPath = parts.slice(0, index + 1).join('/');
                const isLastPart = index === parts.length - 1;
                const listItem = document.createElement('li');
                listItem.className = 'flex items-center';
                if (!isLastPart) {
                    listItem.innerHTML = `<a href="#" class="hover:text-black dark:hover:text-white" data-type="folder" data-path="${currentPath}">${part}</a> <span class="mx-2" aria-hidden="true">/</span>`;
                } else {
                    const count = items.length > 0 ? ` <span class="ml-2 text-gray-500 dark:text-gray-400">(${new Intl.NumberFormat().format(items.length)})</span>` : '';
                    listItem.innerHTML = `<span class="text-black dark:text-white font-medium" aria-current="page">${part}</span>${count}`;
                }
                breadcrumbList.appendChild(listItem);
            });
            ui.breadcrumb.innerHTML = '';
            ui.breadcrumb.appendChild(breadcrumbList);
        }

        function updateAlbumGrid(items) {
            ui.albumGrid.innerHTML = items.map(item => {
                if (item.type === 'folder') {
                    return `<div class="relative group text-center cursor-pointer" data-type="folder" data-id="${item.id}" data-path="${item.path}">
                                <div class="aspect-square bg-gray-200 dark:bg-gray-800 rounded-md flex items-center justify-center border border-transparent group-hover:border-blue-500 transition">
                                    <i class="bi bi-folder2-open text-6xl text-gray-400 dark:text-gray-500"></i>
                                </div>
                                <div class="mt-2"><h5 class="text-sm text-gray-800 dark:text-gray-300 truncate">${item.name}</h5></div>
                            </div>`;
                }
                const actionBtns = `<div class="absolute top-1.5 right-1.5 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="song-info-btn bg-black bg-opacity-60 text-white w-6 h-6 flex items-center justify-center rounded-full cursor-pointer hover:bg-blue-500" data-id="${item.id}" title="Song Info"><i class="bi bi-info-lg"></i></div>
                    <div class="add-to-queue-btn bg-black bg-opacity-60 text-white w-6 h-6 flex items-center justify-center rounded-full cursor-pointer hover:bg-green-500" data-id="${item.id}" title="Add to Queue"><i class="bi bi-plus-lg"></i></div>
                </div>`;
                return `<div class="relative group text-center cursor-pointer" data-type="song" data-id="${item.id}">
                    <div class="aspect-square bg-gray-200 dark:bg-gray-800 rounded-md overflow-hidden border border-transparent group-hover:border-blue-500 transition">
                        <img src="${item.artUrl}" class="w-full h-full object-cover" alt="${item.title}" onerror="this.onerror=null;this.src='assets/no_cover.png';">
                    </div>
                    <div class="mt-2 w-full px-1"><div class="flex items-baseline justify-center space-x-2">
                        <h5 class="text-sm text-gray-800 dark:text-gray-300 truncate">${item.title}</h5>
                        <div class="flex-shrink-0">${getQualityBadge(item)}</div>
                    </div></div>
                    ${actionBtns}
                </div>`;
            }).join('');
        }

        function updateSongList(items) {
            const songListHeader = document.querySelector('#library-list-view thead tr');
            if(songListHeader) songListHeader.innerHTML = `<th scope="col" class="px-6 py-3">Name</th><th scope="col" class="px-6 py-3">Artist</th><th scope="col" class="px-6 py-3">Album</th><th scope="col" class="px-6 py-3 text-right"><i class="bi bi-clock"></i></th><th scope="col" class="px-6 py-3 text-center">Actions</th>`;
            ui.songList.innerHTML = items.map(item => {
                if (item.type === 'folder') return `<tr class="item-row cursor-pointer" data-type="folder" data-id="${item.id}" data-path="${item.path}"><td class="px-6 py-3 font-medium text-black dark:text-white"><i class="bi bi-folder-fill mr-3 text-blue-500 dark:text-blue-400"></i>${item.name}</td><td></td><td></td><td></td><td></td></tr>`;
                return `<tr class="item-row cursor-pointer" data-type="song" data-id="${item.id}">
                    <td class="px-6 py-3 font-medium text-black dark:text-white"><div class="flex items-center space-x-2"><span>${item.title}</span>${getQualityBadge(item)}</div></td>
                    <td class="px-6 py-3">${item.artist || ''}</td><td class="px-6 py-3">${item.album || ''}</td>
                    <td class="px-6 py-3 text-right font-mono">${formatTime(item.duration)}</td>
                    <td class="px-6 py-3 text-center"><i class="song-info-btn bi bi-info-circle-fill text-lg text-gray-500 hover:text-blue-500 cursor-pointer" data-id="${item.id}" title="Song Info"></i></td>
                </tr>`;
            }).join('');
        }

        // --- REFACTOR: Implemented 'updateQueueGrid' function ---
        function updateQueueGrid(queue) {
            if (!queue || queue.length === 0) {
                ui.queueGrid.innerHTML = `<p class="text-center text-gray-500 py-8 col-span-full">The queue is empty.</p>`;
                return;
            }
            ui.queueGrid.innerHTML = queue.map(song => {
                const actionBtns = `<div class="absolute top-1.5 right-1.5 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="delete-queue-item-btn bg-black bg-opacity-60 text-white w-6 h-6 flex items-center justify-center rounded-full cursor-pointer hover:bg-red-500" data-id="${song.id}" title="Remove from Queue"><i class="bi bi-trash"></i></div>
                </div>`;
                return `<div class="relative group text-center cursor-pointer" data-type="song" data-id="${song.id}">
                    <div class="aspect-square bg-gray-200 dark:bg-gray-800 rounded-md overflow-hidden border border-transparent group-hover:border-blue-500 transition">
                        <img src="${song.artUrl}" class="w-full h-full object-cover" alt="${song.title}" onerror="this.onerror=null;this.src='assets/no_cover.png';">
                    </div>
                    <div class="mt-2 w-full px-1"><div class="flex items-baseline justify-center space-x-2">
                        <h5 class="text-sm text-gray-800 dark:text-gray-300 truncate">${song.title}</h5>
                        <div class="flex-shrink-0">${getQualityBadge(song)}</div>
                    </div></div>
                    ${actionBtns}
                </div>`;
            }).join('');
        }

        function updateQueueList(queue) {
            const header = document.querySelector('#queue-list-view thead tr');
            if(header) header.innerHTML = `<th scope="col" class="px-6 py-3">#</th><th scope="col" class="px-6 py-3">Title</th><th scope="col" class="px-6 py-3">Artist</th><th scope="col" class="px-6 py-3">Album</th><th scope="col" class="px-6 py-3 text-right"></th>`;
            if (!queue || queue.length === 0) {
                ui.queueListBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-8">The queue is empty.</td></tr>`;
                return;
            }
            ui.queueListBody.innerHTML = queue.map((song, index) =>
                `<tr class="item-row cursor-pointer" data-id="${song.id}" data-type="song">
                    <td class="px-6 py-3 text-gray-500 dark:text-gray-400">${index + 1}</td>
                    <td class="px-6 py-3 font-medium text-black dark:text-white"><div class="flex items-center space-x-2"><span>${song.title}</span>${getQualityBadge(song)}</div></td>
                    <td class="px-6 py-3">${song.artist}</td><td class="px-6 py-3">${song.album}</td>
                    <td class="px-6 py-3 text-right"><i class="bi bi-trash-fill text-gray-500 hover:text-red-500 cursor-pointer delete-queue-item-btn" data-id="${song.id}"></i></td>
                </tr>`
            ).join('');
        }

        // --- Renderer Checkmark Logic (Unchanged) ---
        function updateRendererCheckmarks() {
            const activeId = currentRenderer ? currentRenderer.targetId : null;
            const allRenderers = ui.rendererDropdownList.querySelectorAll('a[data-udn]');
            allRenderers.forEach(link => {
                const isActive = link.dataset.udn === activeId;
                const checkmark = link.querySelector('i.bi-check-lg');
                if (checkmark) {
                    checkmark.remove();
                }
                if (isActive) {
                    link.insertAdjacentHTML('beforeend', '<i class="bi bi-check-lg text-blue-500 dark:text-blue-400"></i>');
                }
            });
        }
        function updateRendererList(renderers) {
            ui.rendererDropdownList.innerHTML = renderers.map(r =>
                `<a href="#" class="flex justify-between items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-udn="${r.targetId}" data-name="${r.name}">
                    <span>${r.name}</span>
                </a>`
            ).join('');
        }
        // ---

        // ... [renderTrackInfo, showToast, handleEmptyQueue, showConfirmationModal, handleShuffleToggle, handleRepeatToggle, getQualityBadge, updateStats remain unchanged] ...
        function updatePlayerUI() {
            const track = currentTrack;
            const state = currentPlaybackState;

            const isPlaying = state.state === 'playing';
            const elapsed = state.elapsed || 0;
            const duration = (track ? track.duration : 0) || state.duration || 0;
            const progress = (duration > 0) ? (elapsed / duration) * 100 : 0;

            updatePlayerElements(ui.desktopPlayer, track, isPlaying, elapsed, duration, progress);
            updatePlayerElements(ui.mobilePlayer, track, isPlaying, elapsed, duration, progress);

            const footerEl = document.getElementById('player-footer');
            if (track && track.artUrl) {
                try {
                    Vibrant.from(track.artUrl).getPalette().then(palette => {
                        const vibrantColor = palette.DarkMuted || palette.DarkVibrant || palette.Muted;
                        footerEl.style.backgroundColor = vibrantColor ? vibrantColor.getHex() : '';
                        footerEl.classList.toggle('has-color-bg', !!vibrantColor);
                    }).catch(() => {
                        footerEl.style.backgroundColor = '';
                        footerEl.classList.remove('has-color-bg');
                    });
                } catch (err) { /* ignore */ }
            } else {
                footerEl.style.backgroundColor = '';
                footerEl.classList.remove('has-color-bg');
            }

            document.querySelectorAll('.playing-item').forEach(item => item.classList.remove('playing-item'));
            if (track && track.id && currentMainView === 'queue') {
                const currentItemInQueue = document.querySelector(`#queue-content [data-id="${track.id}"][data-type="song"]`);
                if (currentItemInQueue) currentItemInQueue.classList.add('playing-item');
            }

            if (!ui.nowPlayingScreen.classList.contains('hidden')) {
                updateNowPlayingScreenUI(track, state, progress);
            }
        }

        function updatePlayerElements(elements, track, isPlaying, elapsed, duration, progress) {
            if (elements.playPauseBtn) {
                elements.playPauseBtn.classList.toggle('bi-pause-circle-fill', isPlaying);
                elements.playPauseBtn.classList.toggle('bi-play-circle-fill', !isPlaying);
            }

            if(elements.title) elements.title.textContent = track ? track.title : 'No Song Playing';
            if(elements.artistAlbum) elements.artistAlbum.textContent = track ? `${track.artist || 'Unknown Artist'} - ${track.album || 'Unknown Album'}` : 'Artist - Album';
            if(elements.albumArt) elements.albumArt.src = track ? track.artUrl || 'assets/no_cover.png' : 'assets/no_cover.png';
            if(elements.qualityBadge) elements.qualityBadge.innerHTML = track ? getQualityBadge(track) : '';
            if(elements.currentTime) elements.currentTime.textContent = formatTime(elapsed);
            if(elements.duration) elements.duration.textContent = formatTime(duration);
            if(elements.progress) elements.progress.value = progress;
        }

        // --- REFACTOR: Removed redundant 'updatePlayer' and 'updateNowPlayingScreen' functions ---

        function renderTrackInfo(info) {
            if (!info) { ui.infoContentArea.innerHTML = `<p class="text-gray-500">No information found for this track.</p>`; return; }
            let html = '';
            if (info.artistBio) { html += `<div class="mb-6">${info.artistBio}</div>`; } else { html += `<p class="text-gray-500 mb-6">No artist biography found.</p>`; }
            if (info.genres && info.genres.length > 0) {
                html += `<h3 class="text-lg font-semibold text-black dark:text-white mb-2">Genres</h3><div class="flex flex-wrap gap-2">`;
                info.genres.forEach(genre => { html += `<span class="bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-300 text-xs font-medium px-2.5 py-1 rounded-full">${genre}</span>`; });
                html += '</div>';
            }
            ui.infoContentArea.innerHTML = html;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => { toast.classList.add('opacity-0'); }, 2500);
        }

        function handleEmptyQueue() {
            showConfirmationModal(
                'Empty Queue',
                'Are you sure you want to remove all songs from the playing queue?',
                () => {
                    sendMessage({ command: 'emptyQueue' });
                    showToast('Queue cleared!');
                }
            );
        }

        function showConfirmationModal(title, text, onConfirm) {
            ui.modalTitle.textContent = title;
            ui.modalText.textContent = text;
            const newConfirmBtn = ui.modalConfirmBtn.cloneNode(true);
            ui.modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, ui.modalConfirmBtn);
            ui.modalConfirmBtn = newConfirmBtn;
            ui.modalConfirmBtn.onclick = () => {
                onConfirm();
                closeOverlay(ui.confirmationModal);
            };
            openOverlay(ui.confirmationModal);
        }

        function handleShuffleToggle() {
            shuffleMode = !shuffleMode;
            ui.desktopPlayer.shuffleBtn.classList.toggle('text-blue-500', shuffleMode);
            sendMessage({ command: 'setShuffle', enabled: shuffleMode });
            showToast(shuffleMode ? 'Shuffle On' : 'Shuffle Off');
        }

        function handleRepeatToggle() {
            const repeatBtn = ui.desktopPlayer.repeatBtn;
            if (repeatMode === 'none') {
                repeatMode = 'all';
                repeatBtn.classList.add('text-blue-500');
                repeatBtn.classList.remove('bi-repeat-1');
                repeatBtn.classList.add('bi-repeat');
                repeatBtn.title = "Repeat All";
                showToast('Repeat All');
            } else if (repeatMode === 'all') {
                repeatMode = 'one';
                repeatBtn.classList.add('text-blue-500');
                repeatBtn.classList.remove('bi-repeat');
                repeatBtn.classList.add('bi-repeat-1');
                repeatBtn.title = "Repeat One";
                showToast('Repeat One');
            } else {
                repeatMode = 'none';
                repeatBtn.classList.remove('text-blue-500');
                repeatBtn.classList.remove('bi-repeat-1');
                repeatBtn.classList.add('bi-repeat');
                repeatBtn.title = "Repeat Off";
                showToast('Repeat Off');
            }
            sendMessage({ command: 'setRepeatMode', mode: repeatMode });
        }

        function getQualityBadgeHtml(track) {
            if (!track || !track.quality) return '';
            const baseStyle = "text-xs font-medium rounded-full px-2 py-0.5";
            if (track.quality.startsWith('DSD')) return `<span class="${baseStyle} bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300">${track.quality}</span>`;
            if (track.quality.startsWith('MQA')) return `<span class="${baseStyle} bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300">${track.quality}</span>`;
            if (track.quality.startsWith('Hi-Res') || track.quality.startsWith('HR')) return `<span class="${baseStyle} bg-amber-400 text-amber-900 dark:bg-amber-700 dark:text-amber-200">${track.quality}</span>`;
            if (track.quality.startsWith('CD') || track.quality.startsWith('SQ')) return `<span class="${baseStyle} bg-blue-400 text-blue-900 dark:bg-blue-700 dark:text-blue-200">${track.quality}</span>`;
            return `<span class="${baseStyle} bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300">${track.quality}</span>`;
        }

        // NEW HELPER: Returns just the DRS badge (e.g., [icon] DR12)
        function getDrsBadgeHtml(track, addMargin) {
            // Check for undefined or null. 0 is a valid value.
            if (track.drs === undefined || track.drs === null) return '';

            const drValue = parseInt(track.drs, 10); // Ensure it's a number
            if (isNaN(drValue)) return '';

            const baseStyle = "text-xs font-medium rounded-full px-2 py-0.5";
            const drStyle = baseStyle + (addMargin ? ' ml-1' : ''); // Adds left margin

            let colorClasses = '';
            let displayText = '';

            // This logic maps your getDRScoreColor method to Tailwind classes
            if (drValue <= 0) {
                // dr_none: gray
                colorClasses = 'bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300';
                displayText = 'DR N/A';
            } else if (drValue < 8) { // 1-7
                // dr_low: red
                colorClasses = 'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300';
                displayText = `DR${drValue}`;
            } else if (drValue < 13) { // 8-12
                // dr_medium: yellow/amber
                colorClasses = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300';
                displayText = `DR${drValue}`;
            } else { // 13+
                // dr_high: green
                colorClasses = 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300';
                displayText = `DR${drValue}`;
            }

            // This function returns the full HTML string for the badge
            return `<span class="${drStyle} ${colorClasses} inline-flex items-center">
                      <i class="bi bi-bar-chart-line-fill mr-1"></i>${displayText}
                  </span>`;
        }

        function getQualityBadge(track) {
            if (!track) return '';
            const qualityHtml = getQualityBadgeHtml(track);
            // Add margin to DRS badge only if quality badge exists
            const drsHtml = getDrsBadgeHtml(track, !!qualityHtml);
            return qualityHtml + drsHtml;
        }

        function updateStats(stats) {
            if (!stats) return;
            const formatter = new Intl.NumberFormat();
            if (ui.statsSongs) ui.statsSongs.textContent = formatter.format(stats.songs);
            if (ui.statsSize) ui.statsSize.textContent = stats.totalSize;
            if (ui.statsDuration) ui.statsDuration.textContent = stats.totalDuration;
        }

        function openNowPlayingScreen() {
            if (!currentTrack) {
                showToast("Nothing is playing.");
                return;
            }

            const state = currentPlaybackState;
            const duration = (currentTrack ? currentTrack.duration : 0) || state.duration || 0;
            const progress = (duration > 0) ? (state.elapsed / duration) * 100 : 0; // Get 0-100

            // Update all text/art content
            updateNowPlayingScreenUI(currentTrack, currentPlaybackState, progress);

            // Check for metadata (waveform AND bio) and request if missing
            const metadata = trackMetadataCache.get(currentTrack.id);
            if (!metadata) {
                // Show loading spinner for bio
                ui.nowPlayingMetadataContent.innerHTML = '';
                ui.metadataLoadingSpinner.classList.remove('hidden');
                // Request metadata
                sendMessage({ command: 'getTrackMetadata', id: currentTrack.id, artist: currentTrack.artist, album: currentTrack.album });
            } else {
                // We have metadata, draw visuals (waveform and bio)
                // Calculate 0-1 ratio for visuals
                const progressRatio = progress / 100;
                updateNowPlayingScreenVisuals(progressRatio);
            }

            resizeWaveformCanvas();
            openOverlay(ui.nowPlayingScreen);
        }

        // Returns the Tailwind text color class for the quality tier
        function getQualityTierTextColorClass(track) {
            if (!track || !track.quality) return 'text-gray-400'; // Default gray

            if (track.quality.startsWith('DSD')) return 'text-purple-400';
            if (track.quality.startsWith('MQA')) return 'text-green-400';
            if (track.quality.startsWith('Hi-Res') || track.quality.startsWith('HR')) return 'text-amber-400'; // Amber/Yellow
            if (track.quality.startsWith('CD') || track.quality.startsWith('SQ')) return 'text-blue-400';

            return 'text-gray-400'; // Fallback gray
        }

        function updateNowPlayingScreenUI(track, state, progress) {
            if (!track) return;
            ui.nowPlayingTitle.textContent = track.title;
            ui.nowPlayingArt.src = track.artUrl || 'assets/no_cover.png';
            ui.nowPlayingBg.style.backgroundImage = `url(${track.artUrl || 'assets/no_cover.png'})`;

            // --- Feature #1 (Detailed Audio Quality with Separators) ---

            // --- 1. Get and show the 'quality tier' badge ---
            const qualityText = track.quality || ''; // Get the text like "Hi-Res"
            const qualityColorClass = getQualityTierTextColorClass(track); // Get the color like 'text-amber-400'
            let hasFallback = false; // Note: Renamed from hasTier for clarity
            if (qualityText) {
                // Reset old classes
                ui.badgeQualityTier.classList.remove(
                    'text-gray-400', 'text-purple-400', 'text-green-400', 'text-amber-400', 'text-blue-400'
                );
                 // Apply new color class and text
                ui.badgeQualityTier.classList.add(qualityColorClass);
                ui.badgeQualityTier.textContent = qualityText; // Set the text directly
                ui.badgeQualityTier.style.display = 'inline-block';
                hasFallback = true;
            } else {
                ui.badgeQualityTier.style.display = 'none';
                ui.badgeQualityTier.textContent = ''; // Clear text
            }

            // --- 2. Hide all separators first ---
            ui.sepFormatRate.style.display = 'none';
            ui.sepRateDepth.style.display = 'none';
            ui.sepDepthDr.style.display = 'none'; // NEW
            ui.sepDepthTier.style.display = 'none';

            // --- 3. Track which badge was last shown ---
            let lastBadgeShown = null;

            // --- 4. Check for and show the NEW specific badges ---
            if (track.format) {
                // Format Badge
                ui.badgeFormat.innerHTML = track.format;
                ui.badgeFormat.style.display = 'inline-block';
                lastBadgeShown = ui.badgeFormat; // This is the last visible badge

                // Sample Rate Badge
                if (track.sampleRate) {
                    ui.badgeSampleRate.innerHTML = track.sampleRate;
                    ui.badgeSampleRate.style.display = 'inline-block';
                    // Show separator between format and sampleRate
                    ui.sepFormatRate.style.display = 'inline-block';
                    lastBadgeShown = ui.badgeSampleRate; // Update last visible badge
                } else {
                    ui.badgeSampleRate.style.display = 'none';
                }

                // Bit Depth Badge
                if (track.bitDepth) {
                    ui.badgeBitDepth.innerHTML = track.bitDepth;
                    ui.badgeBitDepth.style.display = 'inline-block';

                    // Show the correct preceding separator
                    if (lastBadgeShown === ui.badgeSampleRate) {
                        ui.sepRateDepth.style.display = 'inline-block'; // Show sep after sampleRate
                    } else if (lastBadgeShown === ui.badgeFormat) {
                        ui.sepFormatRate.style.display = 'inline-block'; // Show sep after format
                    }
                    lastBadgeShown = ui.badgeBitDepth; // Update last visible badge
                } else {
                    ui.badgeBitDepth.style.display = 'none';
                }

            } else {
                // --- 6. FALLBACK (No new data) ---
                ui.badgeFormat.style.display = 'none';
                ui.badgeSampleRate.style.display = 'none';
                ui.badgeBitDepth.style.display = 'none';
            }

           /* const drsHtml = getDrsBadgeHtml(track, false); // Generate the full badge HTML (no margin needed here)
            if (drsHtml) {
                ui.badgeDrs.innerHTML = drsHtml; // Set the innerHTML to the generated badge
                ui.badgeDrs.style.display = 'inline-block'; // Use inline-block since it's now a full span

                // Show the correct preceding separator
                if (lastBadgeShown === ui.badgeBitDepth) {
                    ui.sepDepthDr.style.display = 'inline-block';
                } else if (lastBadgeShown === ui.badgeSampleRate) {
                    ui.sepRateDepth.style.display = 'inline-block';
                } else if (lastBadgeShown === ui.badgeFormat) {
                    ui.sepFormatRate.style.display = 'inline-block';
                }
                lastBadgeShown = ui.badgeDrs;
            } else {
                // If drs doesn't exist or isn't a number, hide the badge container
                ui.badgeDrs.style.display = 'none';
                ui.badgeDrs.innerHTML = ''; // Clear content
            } */

            // --- CORRECTED: Add DR Badge Logic with Color ---
            const drsExists = track.drs !== undefined && track.drs !== null;
            const drValue = drsExists ? parseInt(track.drs, 10) : NaN;

            if (drsExists && !isNaN(drValue)) {
                let colorClass = '';
                let displayText = '';

                // Maps your getDRScoreColor logic to text colors
                if (drValue <= 0) { // dr_none: gray
                    colorClass = 'text-gray-400';
                    displayText = 'DR N/A';
                } else if (drValue < 8) { // 1-7 (dr_low: red)
                    colorClass = 'text-red-400';
                    displayText = `DR${drValue}`;
                } else if (drValue < 13) { // 8-12 (dr_medium: yellow)
                    colorClass = 'text-yellow-400';
                    displayText = `DR${drValue}`;
                } else { // 13+ (dr_high: green)
                    colorClass = 'text-green-400';
                    displayText = `DR${drValue}`;
                }

                // Reset old classes
                ui.badgeDrs.classList.remove('text-blue-300', 'text-gray-400', 'text-red-400', 'text-yellow-400', 'text-green-400');
                // Add new color class
                ui.badgeDrs.classList.add(colorClass);

                ui.badgeDrs.innerHTML = `<i class="bi bi-bar-chart-line-fill mr-1"></i>${displayText}`;
                ui.badgeDrs.style.display = 'inline-flex'; // Use inline-flex for icon alignment
                ui.badgeDrs.classList.add('items-center');

                // Show the correct preceding separator
                if (lastBadgeShown === ui.badgeBitDepth) {
                    ui.sepDepthDr.style.display = 'inline-block';
                } else if (lastBadgeShown === ui.badgeSampleRate) {
                    ui.sepRateDepth.style.display = 'inline-block';
                } else if (lastBadgeShown === ui.badgeFormat) {
                    ui.sepFormatRate.style.display = 'inline-block';
                }
                lastBadgeShown = ui.badgeDrs;
            } else {
                // If drs doesn't exist or isn't a number, hide the badge
                ui.badgeDrs.style.display = 'none';
            }

            // --- 5. Show separator before the TIER badge ---
            if (lastBadgeShown && hasFallback) {
                ui.sepDepthTier.style.display = 'inline-block';
            }
            // --- (End of new badge logic) ---

            // Calculate the progress *ratio* (0-1) for the waveform
            const progressRatio = progress / 100;

            ui.nowPlayingArtist.textContent = track.artist ? "by " + track.artist : "";
            ui.nowPlayingArtist.classList.toggle('hidden', !track.artist);
            ui.nowPlayingAlbum.textContent = track.album || "";
            ui.nowPlayingAlbum.classList.toggle('hidden', !track.album);
            ui.nowPlayingYear.textContent = track.year || "";
            ui.nowPlayingYear.classList.toggle('hidden', !track.year);
            ui.nowPlayingYearSeparator.classList.toggle('hidden', !(track.album && track.year));

            // It re-uses the name already stored in the footer
            ui.nowPlayingRenderer.innerHTML = `<i class="bi bi-speaker-fill mr-2"></i>${ui.footerRendererName.textContent}`;

            // Use the 'state' object that was passed in
            ui.nowPlayingTimeCurrent.textContent = formatTime(state.elapsed);
            const duration = track.duration || state.duration || 0;
            ui.nowPlayingTimeDuration.textContent = formatTime(duration);

            // Pass the 0-1 ratio to the drawing function
            updateNowPlayingScreenVisuals(progressRatio);
        }

        function updateNowPlayingScreenVisuals(progressRatio) { // Receives 0-1 ratio
            if (!currentTrack) {
                ui.waveformCanvas.getContext('2d').clearRect(0, 0, ui.waveformCanvas.width, ui.waveformCanvas.height);
                ui.nowPlayingMetadataContent.innerHTML = '';
                ui.metadataLoadingSpinner.classList.add('hidden');
                return;
            }

            const metadata = trackMetadataCache.get(currentTrack.id);

            // 1. Draw Waveform
            if (metadata && metadata.waveform) {
                resizeWaveformCanvas(); // Ensure canvas is sized correctly
                drawWaveform(ui.waveformCanvas, metadata.waveform, progressRatio);
            } else {
                // No waveform data yet, clear the canvas
                ui.waveformCanvas.getContext('2d').clearRect(0, 0, ui.waveformCanvas.width, ui.waveformCanvas.height);
            }

            // 2. Draw Artist/Album Bio
            if (metadata && metadata.info) {
                ui.metadataLoadingSpinner.classList.add('hidden');
                let bioHtml = '';
                if (metadata.info.artistBio) {
                    bioHtml += `<h4 class="font-semibold text-white mb-2">${currentTrack.artist}</h4><p class="text-gray-300">${metadata.info.artistBio}</p>`;
                }
                if (metadata.info.albumBio) {
                     bioHtml += `<h4 class="font-semibold text-white mt-4 mb-2">${currentTrack.album}</h4><p class="text-gray-300">${metadata.info.albumBio}</p>`;
                }
                if (bioHtml === '') {
                    bioHtml = '<p class="text-gray-400">No additional information available.</p>';
                }
                ui.nowPlayingMetadataContent.innerHTML = bioHtml;

            } else {
                // No metadata loaded yet, ensure spinner is visible if screen is open
                ui.nowPlayingMetadataContent.innerHTML = '';
                if (!ui.nowPlayingScreen.classList.contains('hidden')) {
                    ui.metadataLoadingSpinner.classList.remove('hidden');
                }
            }
        }

        // ... [resizeWaveformCanvas and drawWaveform remain unchanged] ...
        function resizeWaveformCanvas() {
            const canvas = ui.waveformCanvas;
            if (!canvas) return;
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
        }

        function drawWaveform(canvas, waveformData, progressPercentage) {
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;
            const center = height / 2;

            ctx.clearRect(0, 0, width, height);
            if (!waveformData || waveformData.length === 0) return;

            const points = waveformData.length / 2;
            const barWidth = Math.max(1, width / points);
            const progressPoint = width * progressPercentage;

            const playedPath = new Path2D();
            const unplayedPath = new Path2D();

            for (let i = 0; i < waveformData.length; i += 2) {
                const x = (i / 2) * barWidth;
                const min = (waveformData[i] || 0) * center;
                const max = (waveformData[i + 1] || 0) * center;
                const barHeight = Math.max(1, max - min);
                const path = (x < progressPoint) ? playedPath : unplayedPath;
                path.rect(x, center + min, barWidth, barHeight);
            }
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fill(playedPath);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.fill(unplayedPath);
        }


        // --- INITIALIZE ---
        renderView();
        connect();
    });
</script>
</body>
</html>