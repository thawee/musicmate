<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: *;
        connect-src 'self' ws: wss:;
        font-src 'self' data:;
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="icons/bootstrap-icons.min.css">
    <script>
        // ADDED: Tell Tailwind to use the 'class' strategy for dark mode
        tailwind.config = {
            darkMode: 'class', // This is crucial for the toggle to work
            theme: {
                extend: {
                    colors: {
                        gray: {
                            '900': '#212529', '800': '#343a40', '700': '#495057',
                            '600': '#6c757d', '300': '#dee2e6', '400': '#adb5bd',
                            '200': '#e9ecef', '100': '#f8f9fa' // Added light grays
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* --- MODIFIED: Custom styles updated for both light and dark themes --- */

        /* Light Theme Scrollbar (Default) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e9ecef; }
        ::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6c757d; }

        /* Dark Theme Scrollbar Override */
        .dark ::-webkit-scrollbar-track { background: #212529; }
        .dark ::-webkit-scrollbar-thumb { background: #495057; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6c757d; }

        /* Progress Bar (Default Light Theme) */
        progress[value] { -webkit-appearance: none; appearance: none; height: 6px; }
        progress[value]::-webkit-progress-bar { background-color: #dee2e6; border-radius: 3px; }
        progress[value]::-webkit-progress-value { background-color: #495057; border-radius: 3px; transition: width 0.1s linear; }
        /* Progress Bar (Dark Theme) */
        .dark progress[value]::-webkit-progress-bar { background-color: #495057; }
        .dark progress[value]::-webkit-progress-value { background-color: #dee2e6; }

        /* Other Styles */
        .overlay-screen { transition: opacity 0.3s ease-in-out; }
        .info-content a { color: #60a5fa; text-decoration: underline; }
        #player-details { transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out; }

        /* Animated Equalizer Icon (no change needed) */
        .playing-icon { display: flex; justify-content: space-between; width: 14px; height: 14px; align-items: flex-end; }
        .playing-icon .bar { width: 3px; height: 100%; background-color: #60a5fa; animation: bounce 1.2s ease-in-out infinite; }
        .playing-icon .bar:nth-child(2) { animation-delay: -1.0s; }
        .playing-icon .bar:nth-child(3) { animation-delay: -0.8s; }
        @keyframes bounce { 0%, 40%, 100% { transform: scaleY(0.2); } 20% { transform: scaleY(1.0); } }

        /* Style for the currently playing song in the queue */
        .playing-item {
            @apply bg-blue-500 bg-opacity-20;
        }
        .dark .playing-item {
            @apply bg-blue-500 bg-opacity-10;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-300 flex flex-col h-screen overflow-hidden font-sans">

<div id="main-ui" class="flex flex-col h-full">
    <header class="bg-white dark:bg-black dark:bg-opacity-20 px-4 py-2 flex-shrink-0 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <a class="text-xl font-semibold text-black dark:text-white" href="#"><i class="bi bi-headphones mr-2"></i>MusicMate</a>
        <div class="flex items-center space-x-4 text-xl">
            <div id="renderer-dropdown-container" class="relative">
                <button id="renderer-dropdown-btn" class="flex items-center text-xl text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white"><i class="bi bi-speaker"></i></button>
                <div id="renderer-dropdown-list" class="absolute hidden right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20 border border-gray-200 dark:border-gray-700"></div>
            </div>
            <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">
                <i class="bi bi-sun-fill hidden"></i> <i class="bi bi-moon-stars-fill"></i> </button>
            <i class="bi bi-gear cursor-pointer text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white"></i>
        </div>
    </header>

    <div id="player-bar-container" class="bg-gray-200 dark:bg-gray-800 flex-shrink-0 border-b border-gray-300 dark:border-gray-700">
        <div id="player-details" class="p-4 flex items-center space-x-4 hidden">
            <img id="player-album-art" src="assets/no_cover.png" class="w-20 h-20 object-cover rounded-md flex-shrink-0 cursor-pointer hover:ring-2 ring-blue-500 transition" alt="Album Art">

            <div class="flex-grow min-w-0 flex items-center justify-between">
                <div class="flex-grow min-w-0 pr-4">
                    <div class="flex items-center">
                        <div class="flex items-center text-3xl text-gray-600 dark:text-gray-300">
                            <i id="prev-btn" class="bi bi-skip-start-fill cursor-pointer hover:text-black dark:hover:text-white"></i>
                            <i id="play-pause-btn" class="bi bi-play-circle-fill mx-4 cursor-pointer hover:text-black dark:hover:text-white"></i>
                            <i id="next-btn" class="bi bi-skip-end-fill cursor-pointer hover:text-black dark:hover:text-white"></i>
                        </div>
                        <div class="ml-4 flex-grow truncate">
                            <div class="flex items-center space-x-2">
                                <h3 id="player-title" class="text-lg font-bold text-black dark:text-white truncate">No Song Playing</h3>
                                <div id="player-quality-badge" class="flex-shrink-0"></div>
                            </div>
                            <p id="player-artist-album" class="text-sm text-gray-600 dark:text-gray-400 truncate">Artist - Album</p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3 mt-2">
                        <div id="player-time-current" class="text-gray-500 dark:text-gray-400 text-sm font-mono">0:00</div>
                        <progress id="player-progress" class="w-full" value="0" max="100"></progress>
                        <div id="player-time-duration" class="text-gray-500 dark:text-gray-400 text-sm font-mono">0:00</div>
                    </div>
                </div>

                <div class="flex items-center space-x-4 text-2xl text-gray-500 dark:text-gray-400 flex-shrink-0">
                    <i id="shuffle-btn" class="bi bi-shuffle cursor-pointer hover:text-blue-500" title="Shuffle"></i>
                    <i id="repeat-btn" class="bi bi-repeat cursor-pointer hover:text-blue-500" title="Repeat All"></i>
                </div>
            </div>
        </div>
        <div class="px-4 py-1 flex justify-between items-center bg-black bg-opacity-5 dark:bg-black dark:bg-opacity-10">
            <div id="player-summary" class="text-sm text-gray-600 dark:text-gray-400 truncate flex items-center">
                <span id="summary-icon-container" class="w-5 mr-2"></span>
                <span>
                <span id="summary-title" class="text-gray-800 dark:text-gray-200">No song playing</span> - <span id="summary-artist">...</span>
                </span>
            </div>
            <i id="toggle-player-btn" class="bi bi-chevron-up text-xl cursor-pointer text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white"></i>
        </div>
    </div>

    <div class="bg-gray-200 dark:bg-gray-800 px-4 py-3 flex items-center justify-between flex-shrink-0 border-b border-gray-300 dark:border-gray-700">
        <div class="flex items-center space-x-4 flex-grow min-w-0">
            <div id="view-switcher" class="text-xl text-gray-500 dark:text-gray-400 space-x-2 flex-shrink-0">
                <i id="library-btn" class="bi bi-collection cursor-pointer text-black dark:text-white" title="Library"></i>
                <i id="queue-btn" class="bi bi-music-note-list cursor-pointer hover:text-black dark:hover:text-white" title="Playing Queue"></i>
                <span class="border-l border-gray-400 dark:border-gray-600 h-6"></span>
                <i id="grid-view-btn" class="bi bi-grid-fill cursor-pointer text-black dark:text-white" title="Grid View"></i>
                <i id="list-view-btn" class="bi bi-list-ul cursor-pointer hover:text-black dark:hover:text-white" title="List View"></i>
            </div>
            <div id="breadcrumb" class="text-sm text-gray-500 dark:text-gray-400 truncate"></div>
        </div>
        <div class="flex items-center space-x-2 flex-shrink-0">
            <div class="flex items-center">
                <button class="bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-300 py-1 px-3 rounded-l-md inline-flex items-center text-sm"><span>Title</span></button>
                <input type="text" class="bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm focus:ring-blue-500 focus:border-blue-500 block w-48 p-1" placeholder="Search...">
            </div>
            <i id="empty-queue-btn" class="bi bi-trash text-xl text-gray-500 dark:text-gray-400 cursor-pointer hover:text-black dark:hover:text-white" title="Empty Queue"></i>
        </div>
    </div>

    <main id="main-content-area" class="flex-grow overflow-y-auto p-4">
        <div id="library-content" class="">
            <div id="library-grid-view"><div id="album-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-4"></div></div>
            <div id="library-list-view" class="hidden"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-200 dark:bg-gray-800"><tr><th scope="col" class="px-6 py-3">Name</th><th scope="col" class="px-6 py-3">Artist</th><th scope="col" class="px-6 py-3">Album</th><th scope="col" class="px-6 py-3 text-right"><i class="bi bi-clock"></i></th></tr></thead><tbody id="song-list"></tbody></table></div>
        </div>
        <div id="queue-content" class="hidden">
            <div id="queue-grid-view" class="hidden"><div id="queue-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-4"></div></div>
            <div id="queue-list-view" class=""><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-200 dark:bg-gray-800"><tr><th scope="col" class="px-6 py-3">#</th><th scope="col" class="px-6 py-3">Title</th><th scope="col" class="px-6 py-3">Artist</th><th scope="col" class="px-6 py-3">Album</th></tr></thead><tbody id="queue-list-body"></tbody></table></div>
        </div>
    </main>
</div>

<div id="toast" class="fixed bottom-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-md shadow-lg opacity-0 transition-opacity"></div>

<div id="now-playing-screen" class="overlay-screen fixed inset-0 bg-gray-100/95 dark:bg-gray-900/95 backdrop-blur-lg h-full w-full flex items-center justify-center p-4 lg:p-8 z-50 hidden opacity-0">
    <button id="close-now-playing-btn" class="absolute top-5 right-8 text-4xl text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white z-10">&times;</button>
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 max-w-6xl w-full h-full lg:h-auto">
        <div class="lg:col-span-2 flex flex-col items-center justify-center text-center">
            <img id="now-playing-art" src="assets/no_cover.png" class="w-64 h-64 lg:w-80 lg:h-80 object-cover rounded-lg shadow-2xl">
            <h1 id="now-playing-title" class="text-3xl lg:text-4xl font-bold text-black dark:text-white mt-4">Song Title</h1>
            <h2 id="now-playing-artist" class="text-xl lg:text-2xl text-blue-600 dark:text-blue-400 mt-1">Artist Name</h2>
            <p id="now-playing-album" class="text-md lg:text-lg text-gray-600 dark:text-gray-400 mt-1">from the album "Album Name"</p>
        </div>
        <div class="lg:col-span-3 bg-white/50 dark:bg-black dark:bg-opacity-20 rounded-lg p-6 flex flex-col h-[60vh] lg:h-auto">
            <div class="flex-shrink-0 border-b border-gray-300 dark:border-gray-700">
                <h3 class="px-3 py-2 font-medium text-black dark:text-white text-lg">Music & Artist Information</h3>
            </div>
            <div class="flex-grow overflow-y-auto mt-4 pr-2 info-content">
                <div id="info-content-area"></div>
                <div id="info-loading-spinner" class="hidden text-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-600 dark:border-gray-300 mx-auto"></div>
                    <p class="mt-4">Fetching info...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Add theme-aware hover effects */
    .dark .item-row:hover { @apply bg-gray-800; }
    .item-row:hover { @apply bg-gray-200; } /* Light theme hover */

    .info-tab { @apply shrink-0 px-3 py-2 font-medium text-sm rounded-t-lg border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white; }
    .dark .info-tab.active { @apply border-blue-500 text-white; }
    .info-tab.active { @apply border-blue-600 text-black; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- THEME SWITCHER LOGIC ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = themeToggleBtn.querySelector('.bi-sun-fill');
        const moonIcon = themeToggleBtn.querySelector('.bi-moon-stars-fill');

        // Function to apply the selected theme
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        };

        // Event listener for the toggle button
        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // Check for saved theme in localStorage or user's OS preference on page load
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (prefersDark) {
            applyTheme('dark');
        } else {
            applyTheme('light'); // Default to light
        }
        // --- END OF THEME SWITCHER LOGIC ---


        // --- CONFIG & STATE ---
        let currentMainView = 'library'; // 'library' or 'queue'
        let currentDisplayMode = 'grid'; // 'grid' or 'list'
        let nowPlayingOverlayTrackId = null;
        let currentBrowsePath = 'Library';
        let shuffleMode = false; // Add this
        let repeatMode = 'none'; // Add this ('none', 'all', 'one')

        // --- UI ELEMENTS ---
        const ui = {
            mainContentArea: document.getElementById('main-content-area'),
            libraryBtn: document.getElementById('library-btn'),
            queueBtn: document.getElementById('queue-btn'),
            gridViewBtn: document.getElementById('grid-view-btn'),
            listViewBtn: document.getElementById('list-view-btn'),
            libraryContent: document.getElementById('library-content'),
            queueContent: document.getElementById('queue-content'),
            libraryGridView: document.getElementById('library-grid-view'),
            libraryListView: document.getElementById('library-list-view'),
            queueGridView: document.getElementById('queue-grid-view'),
            queueListView: document.getElementById('queue-list-view'),
            emptyQueueBtn: document.getElementById('empty-queue-btn'),
            albumGrid: document.getElementById('album-grid'),
            songList: document.getElementById('song-list'),
            queueGrid: document.getElementById('queue-grid'),
            queueListBody: document.getElementById('queue-list-body'),
            breadcrumb: document.getElementById('breadcrumb'),
            playerBarContainer: document.getElementById('player-bar-container'),
            playerDetails: document.getElementById('player-details'),
            togglePlayerBtn: document.getElementById('toggle-player-btn'),
            summaryTitle: document.getElementById('summary-title'),
            summaryArtist: document.getElementById('summary-artist'),
            summaryIconContainer: document.getElementById('summary-icon-container'),
            playerAlbumArt: document.getElementById('player-album-art'),
            nowPlayingScreen: document.getElementById('now-playing-screen'),
            closeNowPlayingBtn: document.getElementById('close-now-playing-btn'),
            rendererDropdownBtn: document.getElementById('renderer-dropdown-btn'),
            rendererDropdownList: document.getElementById('renderer-dropdown-list'),
            nowPlayingArt: document.getElementById('now-playing-art'),
            nowPlayingTitle: document.getElementById('now-playing-title'),
            nowPlayingArtist: document.getElementById('now-playing-artist'),
            nowPlayingAlbum: document.getElementById('now-playing-album'),
            infoContentArea: document.getElementById('info-content-area'),
            infoLoadingSpinner: document.getElementById('info-loading-spinner'),
            playPauseBtn: document.getElementById('play-pause-btn'),
            nextBtn: document.getElementById('next-btn'),
            prevBtn: document.getElementById('prev-btn'),
            shuffleBtn: document.getElementById('shuffle-btn'),
            repeatBtn: document.getElementById('repeat-btn'),
        };

        // --- EVENT LISTENERS ---
        ui.libraryBtn.addEventListener('click', () => setMainView('library'));
        ui.queueBtn.addEventListener('click', () => setMainView('queue'));
        ui.gridViewBtn.addEventListener('click', () => setDisplayMode('grid'));
        ui.listViewBtn.addEventListener('click', () => setDisplayMode('list'));
        ui.playerAlbumArt.addEventListener('click', showNowPlayingDetails);
        ui.closeNowPlayingBtn.addEventListener('click', () => {
            closeOverlay(ui.nowPlayingScreen);
            nowPlayingOverlayTrackId = null;
        });
        ui.mainContentArea.addEventListener('click', handleItemClick);
        ui.breadcrumb.addEventListener('click', handleItemClick);
        ui.togglePlayerBtn.addEventListener('click', () => {
            const isCurrentlyHidden = ui.playerDetails.classList.contains('hidden');
            setPlayerDetailsVisible(isCurrentlyHidden);
        });
        ui.rendererDropdownBtn.addEventListener('click', (e) => { e.stopPropagation(); ui.rendererDropdownList.classList.toggle('hidden'); });
        document.addEventListener('click', () => ui.rendererDropdownList.classList.add('hidden'));
        ui.rendererDropdownList.addEventListener('click', handleRendererSelect);

        ui.playPauseBtn.addEventListener('click', () => sendMessage({ command: 'togglePlayPause' }));
        ui.nextBtn.addEventListener('click', () => sendMessage({ command: 'next' }));
        ui.prevBtn.addEventListener('click', () => sendMessage({ command: 'previous' }));

        ui.emptyQueueBtn.addEventListener('click', handleEmptyQueue);
        ui.shuffleBtn.addEventListener('click', handleShuffleToggle);
        ui.repeatBtn.addEventListener('click', handleRepeatToggle);

        // --- EVENT HANDLERS ---
        function handleItemClick(e) {
            const itemElement = e.target.closest('[data-id]');
            const queueBtn = e.target.closest('.add-to-queue-btn');
            if (queueBtn) {
                e.stopPropagation();
                sendMessage({ command: 'addToQueue', id: queueBtn.dataset.id });
                showToast('Added to queue!');
                return;
            }
            if (!itemElement) return;
            const type = itemElement.dataset.type;
            if (type === 'folder') { sendMessage({ command: 'browse', path: itemElement.dataset.path }); }
            else if (type === 'song') {
                // Differentiate the play command based on the current view
                if (currentMainView === 'library') {
                    // If in the library, rebuild the queue from the current context
                    sendMessage({
                        command: 'playFromContext',
                        id: itemElement.dataset.id,
                        path: currentBrowsePath
                    });
                } else { // Assumes currentMainView is 'queue'
                    // If in the queue, just jump to the selected song
                    sendMessage({
                        command: 'play', // Use a simple 'play' command
                        id: itemElement.dataset.id
                    });
                }
            }
        }

        // --- UI LOGIC ---
        function setMainView(view) {
            if (view === 'library') {
                if (currentMainView === 'library') {
                    // If we are already in the library, clicking the button again acts as a "home" button.
                    sendMessage({ command: 'browse', path: 'Library' });
                } else {
                    // If switching from another view (like queue), just show the library.
                    // It will remember the last content and path automatically.
                    currentMainView = 'library';
                    renderView();
                }
            } else if (view === 'queue') {
                // If we are already in the queue view, do nothing.
                if (currentMainView === 'queue') return;

                currentMainView = 'queue';
                // Always ask for the latest queue data when switching to this view.
                sendMessage({ command: 'getQueue' });
                renderView();
            }
        }

        function setDisplayMode(mode) {
            currentDisplayMode = mode;
            renderView();
        }

        function renderView() {
            ui.libraryContent.classList.add('hidden');
            ui.queueContent.classList.add('hidden');
            // MODIFIED: Use appropriate color classes for active/inactive states
            const activeClasses = ['text-black', 'dark:text-white'];
            const inactiveClasses = ['hover:text-black', 'dark:hover:text-white'];
            ui.libraryBtn.classList.remove(...activeClasses, ...inactiveClasses);
            ui.queueBtn.classList.remove(...activeClasses, ...inactiveClasses);
            ui.libraryBtn.classList.add(...(currentMainView === 'library' ? activeClasses : inactiveClasses));
            ui.queueBtn.classList.add(...(currentMainView === 'queue' ? activeClasses : inactiveClasses));

            ui.gridViewBtn.classList.toggle('text-black', currentDisplayMode === 'grid');
            ui.gridViewBtn.classList.toggle('dark:text-white', currentDisplayMode === 'grid');
            ui.listViewBtn.classList.toggle('text-black', currentDisplayMode === 'list');
            ui.listViewBtn.classList.toggle('dark:text-white', currentDisplayMode === 'list');

            if (currentMainView === 'library') {
                ui.libraryContent.classList.remove('hidden');
                ui.libraryGridView.classList.toggle('hidden', currentDisplayMode !== 'grid');
                ui.libraryListView.classList.toggle('hidden', currentDisplayMode !== 'list');
                ui.breadcrumb.style.visibility = 'visible';
            } else { // queue
                ui.queueContent.classList.remove('hidden');
                ui.queueGridView.classList.toggle('hidden', currentDisplayMode !== 'grid');
                ui.queueListView.classList.toggle('hidden', currentDisplayMode !== 'list');
                updateBreadcrumb('Playing Queue');
                ui.breadcrumb.style.visibility = 'visible';
            }

            ui.emptyQueueBtn.style.display = (currentMainView === 'queue') ? 'inline-block' : 'none';
        }

        function handleRendererSelect(e) {
            e.preventDefault();
            const rendererLink = e.target.closest('a[data-udn]');
            if (rendererLink) {
                const udn = rendererLink.dataset.udn;
                sendMessage({ command: 'setRenderer', udn: udn });
                const name = rendererLink.dataset.name
                showToast('Select '+name+' as renderer');
                ui.rendererDropdownList.classList.add('hidden');
            }
        }

        function openOverlay(overlay) { overlay.classList.remove('hidden'); setTimeout(() => overlay.classList.remove('opacity-0'), 10); }
        function closeOverlay(overlay) { overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 300); }

        function setPlayerDetailsVisible(visible) {
            if (visible && !currentTrack) { return; }
            ui.playerDetails.classList.toggle('hidden', !visible);
            ui.togglePlayerBtn.classList.toggle('bi-chevron-up', visible);
            ui.togglePlayerBtn.classList.toggle('bi-chevron-down', !visible);
        }

        // --- WEBSOCKET LOGIC ---
        const wsUrl = `ws://${window.location.hostname}:9000/ws`;
        let socket;
        function connect() {
            try { socket = new WebSocket(wsUrl); } catch (e) { console.error("WS connect error:", e); setTimeout(connect, 3000); return; }
            socket.onopen = () => { sendMessage({ command: 'browse', path: 'Library' }); sendMessage({ command: 'getNowPlaying' }); sendMessage({ command: 'getRenderers' }); sendMessage({ command: 'getQueue' }); };
            socket.onmessage = (event) => handleServerMessage(JSON.parse(event.data));
            socket.onclose = () => {setTimeout(connect, 3000); };
            socket.onerror = (error) => { console.error("WS error:", error); socket.close(); };
        }
        function sendMessage(message) { if (socket && socket.readyState === WebSocket.OPEN) socket.send(JSON.stringify(message)); }

        function handleServerMessage(data) {
            switch (data.type) {
                case 'browseResult':
                    currentBrowsePath = data.path;
                    updateLibraryItems(data.items);
                    updateBreadcrumb(data.path);
                    break;
                case 'nowPlaying':
                    currentTrack = data.track;
                    if (data.track && data.track.title) {
                        // This part is fine, it calls the function we already fixed.
                        updatePlayer(data.track);
                    } else {
                        // --- THIS BLOCK IS NOW FIXED ---
                        // It now correctly resets all player UI elements to their default state.

                        // Reset summary bar
                        ui.summaryTitle.textContent = 'No song playing';
                        ui.summaryArtist.textContent = '...';
                        ui.summaryIconContainer.innerHTML = '';

                        // Reset expanded player details
                        ui.playerAlbumArt.src = 'assets/no_cover.png';
                        const playerTitleEl = document.getElementById('player-title');
                        const playerArtistAlbumEl = document.getElementById('player-artist-album');
                        const qualityBadgeContainer = document.getElementById('player-quality-badge');
                        const playerProgress = document.getElementById('player-progress');
                        const currentTimeEl = document.getElementById('player-time-current');
                        const durationEl = document.getElementById('player-time-duration');

                        if (playerTitleEl) playerTitleEl.textContent = 'No Song Playing';
                        if (playerArtistAlbumEl) playerArtistAlbumEl.textContent = 'Artist - Album';
                        if (qualityBadgeContainer) qualityBadgeContainer.innerHTML = '';
                        if (currentTimeEl) currentTimeEl.textContent = '0:00';
                        if (durationEl) durationEl.textContent = '0:00';
                        if (playerProgress) playerProgress.value = 0;

                        // Hide the detailed player
                        setPlayerDetailsVisible(false);
                    }
                    if (!ui.nowPlayingScreen.classList.contains('hidden')) {
                        refreshNowPlayingOverlay(data.track);
                    }
                    break;
                case 'nowPlayingOld':
                    currentTrack = data.track;
                    if (data.track && data.track.title) {
                        updatePlayer(data.track);
                    } else {
                        ui.summaryTitle.textContent = 'No song playing';
                        ui.summaryArtist.textContent = '...';
                        ui.playerAlbumArt.src = 'assets/no_cover.png';
                        document.getElementById('player-time').textContent = '0:00 / 0:00';
                        document.getElementById('player-progress').value = 0;
                        ui.summaryIconContainer.innerHTML = '';
                        setPlayerDetailsVisible(false);
                    }
                    if (!ui.nowPlayingScreen.classList.contains('hidden')) {
                        refreshNowPlayingOverlay(data.track);
                    }
                    break;
                case 'dlnaRenderers': updateRendererList(data.renderers); break;
                case 'updateQueue': updateQueueItems(data.queue); break;
                case 'trackInfoResult':
                    ui.infoLoadingSpinner.classList.add('hidden');
                    if (data.info) {
                        if (data.info.highResArtUrl) {
                            ui.nowPlayingArt.src = data.info.highResArtUrl;
                        }
                        renderTrackInfo(data.info);
                    } else {
                       renderTrackInfo(null);
                    }
                    break;
            }
        }

        // --- RENDERING LOGIC ---
        function updateLibraryItems(items) {
            updateAlbumGrid(items);
            updateSongList(items);
            const isFolderOnly = items.every(item => item.type === 'folder');
            ui.listViewBtn.classList.toggle('opacity-50', isFolderOnly);
            ui.listViewBtn.classList.toggle('pointer-events-none', isFolderOnly);
            if (isFolderOnly && currentDisplayMode === 'list') { setDisplayMode('grid'); }
        }

        function updateQueueItems(queue) {
            updateQueueGrid(queue);
            updateQueueList(queue);
        }

        function formatTime(seconds) { if (isNaN(seconds)) return '0:00'; const min = Math.floor(seconds / 60); const sec = Math.floor(seconds % 60).toString().padStart(2, '0'); return `${min}:${sec}`; }
        // Breadcrumb now uses theme-aware text color for the final part
        function updateBreadcrumb(path) { const parts = path.split('/'); let html = ''; let currentPath = ''; parts.forEach((part, index) => { currentPath += (index > 0 ? '/' : '') + part; if (index < parts.length - 1) { html += `<a href="#" class="hover:text-black dark:hover:text-white" data-type="folder" data-path="${currentPath}">${part}</a> <span class="mx-1">/</span> `; } else { html += `<span class="text-black dark:text-white font-medium">${part}</span>`; } }); ui.breadcrumb.innerHTML = html; }
        // Grid items now use theme-aware classes
        //function updateAlbumGrid(items) { ui.albumGrid.innerHTML = items.map(item => { const addBtn = `<div class="add-to-queue-btn absolute top-1.5 right-1.5 bg-black bg-opacity-60 text-white w-6 h-6 flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 transition-opacity" data-id="${item.id}"><i class="bi bi-plus-lg"></i></div>`; if (item.type === 'folder') { return `<div class="relative group text-center cursor-pointer" data-type="folder" data-id="${item.id}" data-path="${item.path}"><div class="aspect-square bg-gray-200 dark:bg-gray-800 rounded-md flex items-center justify-center border border-transparent group-hover:border-blue-500 transition"><i class="bi bi-folder2-open text-6xl text-gray-400 dark:text-gray-500"></i></div><div class="mt-2"><h5 class="text-sm text-gray-800 dark:text-gray-300 truncate">${item.name}</h5></div></div>`; } else { const qualityBadge = getQualityBadge(item); return `<div class="relative group text-center cursor-pointer" data-type="song" data-id="${item.id}"><div class="aspect-square bg-gray-200 dark:bg-gray-800 rounded-md overflow-hidden border border-transparent group-hover:border-blue-500 transition"><img src="${item.artUrl}" class="w-full h-full object-cover" alt="${item.name}" onerror="this.onerror=null;this.src='assets/no_cover.png';"> <div class="absolute bottom-1 left-1">${qualityBadge}</div></div><div class="mt-2"><h5 class="text-sm text-gray-800 dark:text-gray-300 truncate">${item.name}</h5></div>${addBtn}</div>`; } }).join(''); }
        function updateAlbumGrid(items) {
            ui.albumGrid.innerHTML = items.map(item => {
                const addBtn = `<div class="add-to-queue-btn absolute top-1.5 right-1.5 bg-black bg-opacity-60 text-white w-6 h-6 flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 transition-opacity" data-id="${item.id}"><i class="bi bi-plus-lg"></i></div>`;
                if (item.type === 'folder') {
                    return `<div class="relative group text-center cursor-pointer" data-type="folder" data-id="${item.id}" data-path="${item.path}">
                                <div class="aspect-square bg-gray-200 dark:bg-gray-800 rounded-md flex items-center justify-center border border-transparent group-hover:border-blue-500 transition">
                                    <i class="bi bi-folder2-open text-6xl text-gray-400 dark:text-gray-500"></i>
                                </div>
                                <div class="mt-2"><h5 class="text-sm text-gray-800 dark:text-gray-300 truncate">${item.name}</h5></div>
                            </div>`;
                } else {
                    const qualityBadge = getQualityBadge(item);
                    // MODIFIED: Re-added the missing ${addBtn} at the end
                    return `<div class="relative group text-center cursor-pointer" data-type="song" data-id="${item.id}">
                                <div class="aspect-square bg-gray-200 dark:bg-gray-800 rounded-md overflow-hidden border border-transparent group-hover:border-blue-500 transition">
                                    <img src="${item.artUrl}" class="w-full h-full object-cover" alt="${item.name}" onerror="this.onerror=null;this.src='assets/no_cover.png';">
                                </div>
                                <div class="mt-2 w-full px-1">
                                    <div class="flex items-baseline justify-center space-x-2">
                                        <h5 class="text-sm text-gray-800 dark:text-gray-300 truncate">${item.name}</h5>
                                        <div class="flex-shrink-0">${qualityBadge}</div>
                                    </div>
                                </div>
                                ${addBtn}
                            </div>`;
                }
            }).join('');
        }
        //function updateSongList(items) { ui.songList.innerHTML = items.map(item => { if (item.type === 'folder') { return `<tr class="item-row cursor-pointer" data-type="folder" data-id="${item.id}" data-path="${item.path}"><td class="px-6 py-3 font-medium text-black dark:text-white"><i class="bi bi-folder-fill mr-3 text-blue-500 dark:text-blue-400"></i>${item.name}</td><td></td><td></td><td></td></tr>`; } else { const qualityBadge = getQualityBadge(item); return `<tr class="item-row cursor-pointer" data-type="song" data-id="${item.id}"><td class="px-6 py-3 font-medium text-black dark:text-white">${item.name} <div class="mt-1">${qualityBadge}</div></td><td class="px-6 py-3">${item.artist || ''}</td><td class="px-6 py-3">${item.album || ''}</td><td class="px-6 py-3 text-right font-mono">${formatTime(item.duration)}</td></tr>`; } }).join(''); }
        function updateSongList(items) {
            ui.songList.innerHTML = items.map(item => {
                if (item.type === 'folder') {
                    return `<tr class="item-row cursor-pointer" data-type="folder" data-id="${item.id}" data-path="${item.path}">
                                <td class="px-6 py-3 font-medium text-black dark:text-white"><i class="bi bi-folder-fill mr-3 text-blue-500 dark:text-blue-400"></i>${item.name}</td>
                                <td></td><td></td><td></td>
                            </tr>`;
                } else {
                    const qualityBadge = getQualityBadge(item);
                    return `<tr class="item-row cursor-pointer" data-type="song" data-id="${item.id}">
                                <td class="px-6 py-3 font-medium text-black dark:text-white">
                                    <div class="flex items-center space-x-2">
                                        <span>${item.name}</span>
                                        ${qualityBadge}
                                    </div>
                                </td>
                                <td class="px-6 py-3">${item.artist || ''}</td>
                                <td class="px-6 py-3">${item.album || ''}</td>
                                <td class="px-6 py-3 text-right font-mono">${formatTime(item.duration)}</td>
                            </tr>`;
                }
            }).join('');
        }

        function updateQueueGrid(queue) {
            if (!queue || queue.length === 0) { /* ... */ return; }
            ui.queueGrid.innerHTML = queue.map(song => {
                const deleteBtn = `<div class="delete-queue-item-btn ..." data-id="${song.id}"><i class="bi bi-x-lg"></i></div>`;
                const qualityBadge = getQualityBadge(song);
                // MODIFIED: The badge is now below the image, next to the title
                return `<div class="relative group text-center cursor-pointer" data-id="${song.id}" data-type="song">
                            <div class="aspect-square bg-gray-200 dark:bg-gray-800 rounded-md overflow-hidden border border-transparent group-hover:border-blue-500 transition">
                                <img src="${song.artUrl}" class="w-full h-full object-cover" alt="${song.title}" onerror="this.onerror=null;this.src='assets/no_cover.png';">
                            </div>
                            <div class="mt-2 w-full px-1">
                                <div class="flex items-baseline justify-center space-x-2">
                                    <h5 class="text-sm text-gray-800 dark:text-gray-300 truncate">${song.title}</h5>
                                    <div class="flex-shrink-0">${qualityBadge}</div>
                                </div>
                            </div>
                            ${deleteBtn}
                        </div>`;
            }).join('');
        }

       /* function updateQueueGrid(queue) {
            if (!queue || queue.length === 0) {
                ui.queueGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">The queue is empty.</p>`;
                return;
            }
            ui.queueGrid.innerHTML = queue.map(song => {
                // ADD a delete button template
                const deleteBtn = `
                    <div class="delete-queue-item-btn absolute top-1.5 right-1.5 bg-black bg-opacity-60 text-white w-6 h-6 flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer hover:bg-red-500" data-id="${song.id}">
                        <i class="bi bi-x-lg"></i>
                    </div>`;

                // MODIFY the return statement to include the delete button
                const qualityBadge = getQualityBadge(song);
                return `<div class="relative group text-center cursor-pointer" data-id="${song.id}" data-type="song">
                            <div class="aspect-square bg-gray-200 dark:bg-gray-800 rounded-md overflow-hidden border border-transparent group-hover:border-blue-500 transition">
                                <img src="${song.artUrl}" class="w-full h-full object-cover" alt="${song.title}" onerror="this.onerror=null;this.src='assets/no_cover.png';">
                                <div class="absolute bottom-1 left-1">${qualityBadge}</div>
                            </div>
                            <div class="mt-2"><h5 class="text-sm text-gray-800 dark:text-gray-300 truncate">${song.title}</h5></div>
                            ${deleteBtn}
                        </div>`;
            }).join('');
        } */

        function updateSongList(items) {
            ui.songList.innerHTML = items.map(item => {
                if (item.type === 'folder') {
                    return `<tr class="item-row cursor-pointer" data-type="folder" data-id="${item.id}" data-path="${item.path}">
                                <td class="px-6 py-3 font-medium text-black dark:text-white"><i class="bi bi-folder-fill mr-3 text-blue-500 dark:text-blue-400"></i>${item.name}</td>
                                <td></td><td></td><td></td>
                            </tr>`;
                } else {
                    const qualityBadge = getQualityBadge(item);
                    return `<tr class="item-row cursor-pointer" data-type="song" data-id="${item.id}">
                                <td class="px-6 py-3 font-medium text-black dark:text-white">
                                    <div class="flex items-center space-x-2">
                                        <span>${item.name}</span>
                                        ${qualityBadge}
                                    </div>
                                </td>
                                <td class="px-6 py-3">${item.artist || ''}</td>
                                <td class="px-6 py-3">${item.album || ''}</td>
                                <td class="px-6 py-3 text-right font-mono">${formatTime(item.duration)}</td>
                            </tr>`;
                }
            }).join('');
        }

       /* function updateQueueList(queue) {
            // First, find the <thead> for the queue list view and update its header row
            const queueListHeader = document.querySelector('#queue-list-view thead tr');
            if (queueListHeader) {
                queueListHeader.innerHTML = `
                    <th scope="col" class="px-6 py-3">#</th>
                    <th scope="col" class="px-6 py-3">Title</th>
                    <th scope="col" class="px-6 py-3">Artist</th>
                    <th scope="col" class="px-6 py-3">Album</th>
                    <th scope="col" class="px-6 py-3 text-right"></th>`; // Empty header for the delete button
            }

            if (!queue || queue.length === 0) {
                ui.queueListBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-8">The queue is empty.</td></tr>`;
                return;
            }
            // This now only creates ONE delete icon per row with the correct class.
            const qualityBadge = getQualityBadge(song);
            ui.queueListBody.innerHTML = queue.map((song, index) =>
                `<tr class="item-row cursor-pointer" data-id="${song.id}" data-type="song">
                    <td class="px-6 py-3 text-gray-500 dark:text-gray-400">${index + 1}</td>
                    <td class="px-6 py-3 font-medium text-black dark:text-white">${song.title} <div class="mt-1">${qualityBadge}</div></td>
                    <td class="px-6 py-3">${song.artist}</td>
                    <td class="px-6 py-3">${song.album}</td>
                    <td class="px-6 py-3 text-right">
                        <i class="bi bi-trash-fill text-gray-500 hover:text-red-500 cursor-pointer delete-queue-item-btn" data-id="${song.id}"></i>
                    </td>
                </tr>`
            ).join('');
        } */
        function updateRendererList(renderers) { ui.rendererDropdownList.innerHTML = renderers.map(r => `<a href="#" class="flex justify-between items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-udn="${r.udn}" data-name="${r.name}"><span>${r.name}</span>${r.active ? '<i class="bi bi-check-lg text-blue-500 dark:text-blue-400"></i>' : ''}</a>`).join(''); }

        function updatePlayer(track) {
            // --- Update All Player Elements ---
            // Expanded Player Details
            const playerTitleEl = document.getElementById('player-title');
            const playerArtistAlbumEl = document.getElementById('player-artist-album');
            const qualityBadgeContainer = document.getElementById('player-quality-badge');

            if (playerTitleEl) playerTitleEl.textContent = track.title;
            if (playerArtistAlbumEl) playerArtistAlbumEl.textContent = `${track.artist || ''} - ${track.album || ''}`;
            if (qualityBadgeContainer) qualityBadgeContainer.innerHTML = getQualityBadge(track);

            // Album Art
            ui.playerAlbumArt.src = track.artUrl || 'assets/no_cover.png';

            // Collapsed Summary Bar
            ui.summaryTitle.textContent = track.title;
            ui.summaryArtist.textContent = track.artist;

            // Time and Progress Bar
            const playerProgress = document.getElementById('player-progress');
            const currentTimeEl = document.getElementById('player-time-current');
            const durationEl = document.getElementById('player-time-duration');

            if (playerProgress && currentTimeEl && durationEl) {
                currentTimeEl.textContent = formatTime(track.elapsed);
                durationEl.textContent = formatTime(track.duration);
                playerProgress.value = track.duration > 0 ? (track.elapsed / track.duration) * 100 : 0;
            }

            // Summary Icon (Equalizer)
            if (track.state === 'playing') {
                ui.summaryIconContainer.innerHTML = `<div class="playing-icon"><span class="bar"></span><span class="bar"></span><span class="bar"></span></div>`;
            } else if (track.state === 'paused') {
                ui.summaryIconContainer.innerHTML = '<i class="bi bi-pause-fill text-blue-500 dark:text-blue-400"></i>';
            } else {
                ui.summaryIconContainer.innerHTML = '<i class="bi bi-music-note text-gray-500"></i>';
            }

            // Main Play/Pause Button
            const playPauseIcon = ui.playPauseBtn;
            playPauseIcon.classList.remove('bi-play-circle-fill', 'bi-pause-circle-fill');
            if (track.state === 'playing') {
                playPauseIcon.classList.add('bi-pause-circle-fill');
            } else {
                playPauseIcon.classList.add('bi-play-circle-fill');
            }

            // Highlight the Currently Playing Track in the Queue
            document.querySelectorAll('.playing-item').forEach(item => {
                item.classList.remove('playing-item');
            });
            if (track && track.id && currentMainView === 'queue') {
                const currentItemInQueue = document.querySelector(`.item-row[data-id="${track.id}"], .group[data-id="${track.id}"]`);
                if (currentItemInQueue) {
                    currentItemInQueue.classList.add('playing-item');
                }
            }
        }

        function refreshNowPlayingOverlay(track) {
            if (track) {
                ui.nowPlayingArt.src = track.artUrl || 'assets/no_cover.png';
                ui.nowPlayingTitle.textContent = track.title;
                ui.nowPlayingArtist.textContent = track.artist || 'Unknown Artist';
                ui.nowPlayingAlbum.textContent = track.album ? `from the album "${track.album}"` : '';
                if (track.id !== nowPlayingOverlayTrackId) {
                    nowPlayingOverlayTrackId = track.id;
                    ui.infoLoadingSpinner.classList.remove('hidden');
                    ui.infoContentArea.innerHTML = '';
                    sendMessage({ command: 'getTrackInfo', artist: track.artist, album: track.album });
                }
            } else {
                ui.nowPlayingArt.src = 'assets/no_cover.png';
                ui.nowPlayingTitle.textContent = 'Nothing Playing';
                ui.nowPlayingArtist.textContent = '...';
                ui.nowPlayingAlbum.textContent = '';
                ui.infoContentArea.innerHTML = '<p class="text-gray-500">Play a song to see artist and album information.</p>';
                nowPlayingOverlayTrackId = null;
            }
        }

        function showNowPlayingDetails() {
            nowPlayingOverlayTrackId = null;
            refreshNowPlayingOverlay(currentTrack);
            openOverlay(ui.nowPlayingScreen);
        }

        function renderTrackInfo(info) {
            if (!info) { ui.infoContentArea.innerHTML = `<p class="text-gray-500">No information found for this track.</p>`; return; }
            let html = '';
            if (info.artistBio) { html += `<div class="mb-6">${info.artistBio}</div>`; } else { html += `<p class="text-gray-500 mb-6">No artist biography found.</p>`; }
            if (info.genres && info.genres.length > 0) {
                html += `<h3 class="text-lg font-semibold text-black dark:text-white mb-2">Genres</h3>`;
                html += '<div class="flex flex-wrap gap-2">';
                info.genres.forEach(genre => { html += `<span class="bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-300 text-xs font-medium px-2.5 py-1 rounded-full">${genre}</span>`; });
                html += '</div>';
            }
            ui.infoContentArea.innerHTML = html;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => { toast.classList.add('opacity-0'); }, 2500);
        }

        function handleEmptyQueue() {
            if (confirm('Are you sure you want to empty the entire queue?')) {
                sendMessage({ command: 'emptyQueue' });
            }
        }

        function handleShuffleToggle() {
            shuffleMode = !shuffleMode;
            // Toggle blue color to show active state
            ui.shuffleBtn.classList.toggle('text-blue-500', shuffleMode);
            // Tell the server about the change
            sendMessage({ command: 'setShuffle', enabled: shuffleMode });
            showToast(shuffleMode ? 'Shuffle On' : 'Shuffle Off');
        }

        function handleRepeatToggle() {
            if (repeatMode === 'none') {
                repeatMode = 'all';
                ui.repeatBtn.classList.add('text-blue-500'); // Blue for Repeat All
                ui.repeatBtn.classList.remove('bi-repeat');
                ui.repeatBtn.classList.add('bi-repeat'); // Ensure correct icon
                ui.repeatBtn.title = "Repeat All";
                showToast('Repeat All');
            } else if (repeatMode === 'all') {
                repeatMode = 'one';
                ui.repeatBtn.classList.add('text-blue-500'); // Stays blue
                ui.repeatBtn.classList.remove('bi-repeat');
                ui.repeatBtn.classList.add('bi-repeat-1'); // Change icon to 'repeat-1'
                ui.repeatBtn.title = "Repeat One";
                showToast('Repeat One');
            } else { // repeatMode is 'one'
                repeatMode = 'none';
                ui.repeatBtn.classList.remove('text-blue-500'); // Deactivate color
                ui.repeatBtn.classList.remove('bi-repeat-1');
                ui.repeatBtn.classList.add('bi-repeat');
                ui.repeatBtn.title = "Repeat Off";
                showToast('Repeat Off');
            }
            // Tell the server about the change
            sendMessage({ command: 'setRepeatMode', mode: repeatMode });
        }

        function getQualityBadge(track) {
            if (!track) return '';

            const baseStyle = "text-xs font-medium rounded-full px-2 py-0.5";

            if (track.format && track.format.startsWith('DSD')) {
                const dsdStyle = "bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300";
                return `<span class="${baseStyle} ${dsdStyle}">${track.format}</span>`;
            }
            if (track.isMQA === true) {
                const mqaStyle = "bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300";
                return `<span class="${baseStyle} ${mqaStyle}">MQA</span>`;
            }
            if (track.bitDepth > 16 || track.sampleRate > 44100) {
                // MODIFIED: Swapped 'stone' for a slightly stronger 'zinc'
                const hiresStyle = "bg-zinc-200 text-zinc-700 dark:bg-zinc-700 dark:text-zinc-300";
                return `<span class="${baseStyle} ${hiresStyle}">Hi-Res</span>`;
            }
            if (track.bitDepth === 16 && track.sampleRate === 44100) {
                const cdStyle = "bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300";
                return `<span class="${baseStyle} ${cdStyle}">CD</span>`;
            }
            return '';
        }

        // --- INITIALIZE ---
        renderView();
        connect();
    });
</script>
</body>
</html>